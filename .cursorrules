# IncidentFox v0 Development Rules for Cursor AI

## üö® CRITICAL CONTEXT

This is **IncidentFox v0** - an enterprise AI SRE system **running in production customer environments**.
- **Status:** Customer launch week of January 13, 2026
- **Deployment:** AWS EKS (us-west-2, namespace: incidentfox)
- **Customers:** Already using this in production
- **Quality bar:** Enterprise-grade - no exceptions

**Every change must be:**
- ‚úÖ Well-tested
- ‚úÖ Backwards compatible
- ‚úÖ Documented (if customer-visible)
- ‚úÖ Secure (never commit secrets)
- ‚úÖ EKS-compatible (build with --platform linux/amd64)

---

## üìö Documentation Index (Read These First)

| Document | Purpose | When to Read |
|----------|---------|--------------|
| [DEVELOPMENT_KNOWLEDGE.md](DEVELOPMENT_KNOWLEDGE.md) | **Comprehensive dev reference** | Before any work - has everything |
| [README.md](README.md) | High-level overview | Understanding product |
| [docs/DOCUMENTATION_PLAN_V0.md](docs/DOCUMENTATION_PLAN_V0.md) | Documentation structure | Understanding docs |
| [docs/TECH_DEBT.md](docs/TECH_DEBT.md) | All TODOs and tech debt | Before adding TODOs |
| [agent/README.md](agent/README.md) | Agent architecture | Working on agent service |
| [config_service/README.md](config_service/README.md) | Config API | Working on config service |
| [orchestrator/README.md](orchestrator/README.md) | Webhook routing | Working on orchestrator |
| [web_ui/README.md](web_ui/README.md) | Frontend | Working on web UI |

---

## üèóÔ∏è Architecture Overview

### 4 Core Services

1. **agent** (Python/Poetry) - Multi-agent runtime
   - Port: 8080
   - Image: `103002841599.dkr.ecr.us-west-2.amazonaws.com/incidentfox-agent:latest`
   - 6 agents: Planner, K8s, AWS, Metrics, Coding, Investigation
   - 178 built-in tools + MCP servers

2. **config_service** (Python/FastAPI) - Control plane
   - Port: 8080
   - Image: `103002841599.dkr.ecr.us-west-2.amazonaws.com/incidentfox-config-service:latest`
   - Database: PostgreSQL RDS
   - Manages: org hierarchy, team configs, tokens, integrations

3. **orchestrator** (Python/FastAPI) - Webhook routing
   - Port: 8080
   - Image: `103002841599.dkr.ecr.us-west-2.amazonaws.com/incidentfox-orchestrator:latest`
   - Handles: Slack, GitHub, PagerDuty, Incident.io webhooks
   - Routes to teams via Config Service lookup

4. **web_ui** (Next.js/pnpm) - Admin & Team console
   - Port: 3000
   - Image: `103002841599.dkr.ecr.us-west-2.amazonaws.com/incidentfox-web-ui:latest`
   - **IMPORTANT:** Use pnpm, NOT npm or yarn

### Key Architectural Patterns

**1. Hierarchical Configuration**
- Inheritance: root org ‚Üí group ‚Üí team ‚Üí sub-team
- Deep merge: dicts merge recursively, lists replace entirely
- Immutable fields: Enforced server-side
- Cache invalidation: Via org epoch increment

**2. Tool Pool Architecture**
- Built-in tools: 178 tools from catalog
- MCP servers: Model Context Protocol servers per team
- Team-disabled: Blacklist specific tool IDs
- Team-enabled: Whitelist for restricted tools
- Execution context: All tools receive `{org_id, team_node_id, user_id}`

**3. Multi-Destination Output**
- Slack: Block Kit messages with real-time updates
- GitHub: PR/issue comments (markdown)
- PagerDuty: Notes (future)
- Incident.io: Timeline entries (future)

**4. Webhook Routing**
- **All webhooks ‚Üí Orchestrator** (not Agent, not Web UI)
- Signature verification for each source
- Team lookup via routing identifiers:
  - Slack channel ID ‚Üí team
  - GitHub repo ‚Üí team
  - PagerDuty service ID ‚Üí team
  - Incident.io alert source ‚Üí team

**5. Dynamic Agent System**
- Agents defined in JSON config (not hardcoded Python)
- Runtime construction from team config
- Tool filtering based on enabled/disabled lists
- Agent-as-tool pattern for sub-agents

---

## üîê Getting Secrets from Kubernetes

```bash
# OpenAI API key
kubectl get secret incidentfox-secrets -n incidentfox -o jsonpath='{.data.OPENAI_API_KEY}' | base64 -d

# Slack bot token
kubectl get secret incidentfox-slack -n incidentfox -o jsonpath='{.data.SLACK_BOT_TOKEN}' | base64 -d

# Database connection string
kubectl get secret incidentfox-db -n incidentfox -o jsonpath='{.data.DATABASE_URL}' | base64 -d

# All secrets in namespace
kubectl get secrets -n incidentfox

# Describe secret (shows keys, not values)
kubectl describe secret incidentfox-secrets -n incidentfox
```

---

## üöÄ Deployment Procedures

### ECR Login (Required Before Push)

```bash
aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin 103002841599.dkr.ecr.us-west-2.amazonaws.com
```

### Agent Deployment

```bash
cd agent
docker build --platform linux/amd64 -t 103002841599.dkr.ecr.us-west-2.amazonaws.com/incidentfox-agent:latest .
docker push 103002841599.dkr.ecr.us-west-2.amazonaws.com/incidentfox-agent:latest
kubectl rollout restart deployment/incidentfox-agent -n incidentfox
kubectl rollout status deployment/incidentfox-agent -n incidentfox --timeout=90s
```

### Config Service Deployment

```bash
cd config_service
docker build --platform linux/amd64 -t 103002841599.dkr.ecr.us-west-2.amazonaws.com/incidentfox-config-service:latest .
docker push 103002841599.dkr.ecr.us-west-2.amazonaws.com/incidentfox-config-service:latest
kubectl rollout restart deployment/incidentfox-config-service -n incidentfox
```

### Orchestrator Deployment

```bash
cd orchestrator
docker build --platform linux/amd64 -t 103002841599.dkr.ecr.us-west-2.amazonaws.com/incidentfox-orchestrator:latest .
docker push 103002841599.dkr.ecr.us-west-2.amazonaws.com/incidentfox-orchestrator:latest
kubectl rollout restart deployment/incidentfox-orchestrator -n incidentfox
```

### Web UI Deployment

```bash
cd web_ui
docker build --platform linux/amd64 -t 103002841599.dkr.ecr.us-west-2.amazonaws.com/incidentfox-web-ui:latest .
docker push 103002841599.dkr.ecr.us-west-2.amazonaws.com/incidentfox-web-ui:latest
kubectl rollout restart deployment/incidentfox-web-ui -n incidentfox
```

**‚ö†Ô∏è CRITICAL:** Always use `--platform linux/amd64` - EKS cluster runs on AMD64 nodes

---

## üóÑÔ∏è Database Migrations

```bash
# Config Service migrations (Alembic)
cd config_service
source .env  # Must have DATABASE_URL
alembic upgrade head

# Check current migration
alembic current

# Create new migration (after SQLAlchemy model changes)
alembic revision --autogenerate -m "description of change"

# NEVER:
# - Skip migrations
# - Modify existing migration files
# - Run migrations without backup
```

---

## üîß Local Development

### Port Forwarding

```bash
# Config Service
kubectl port-forward -n incidentfox svc/incidentfox-config-service 8090:8080

# Agent
kubectl port-forward -n incidentfox svc/incidentfox-agent 8080:8080

# Web UI
kubectl port-forward -n incidentfox svc/incidentfox-web-ui 3000:3000
```

### Viewing Logs

```bash
# Tail logs (all pods in deployment)
kubectl logs -n incidentfox deploy/incidentfox-agent --tail=100 -f

# Specific pod
kubectl logs -n incidentfox incidentfox-agent-xxx-yyy --tail=100 -f

# All containers in pod
kubectl logs -n incidentfox incidentfox-agent-xxx-yyy --all-containers=true
```

### Pod Status

```bash
# All pods
kubectl get pods -n incidentfox

# With more details
kubectl get pods -n incidentfox -o wide

# Watch for changes
kubectl get pods -n incidentfox -w

# Execute command in pod
kubectl exec -n incidentfox deploy/incidentfox-agent -- python -c "import sys; print(sys.version)"
```

---

## ‚ûï When Adding Features

### New Integration

1. **Add to integration_schemas table**
   ```sql
   INSERT INTO integration_schemas (id, name, category, description, fields)
   VALUES ('datadog', 'Datadog', 'monitoring', 'Datadog APM and metrics', '[...]');
   ```

2. **Create tool file:** `agent/src/ai_agent/tools/{integration}_tools.py`
   ```python
   def get_datadog_metrics(execution_context: Dict[str, Any], query: str) -> str:
       """Query Datadog metrics API.

       Args:
           execution_context: Contains org_id, team_node_id, user_id
           query: Datadog query string

       Returns:
           JSON string with success/error and result
       """
       org_id = execution_context.get("org_id")
       # Get integration config from execution context
       # Make API call
       return json.dumps({"success": True, "result": {...}})
   ```

3. **Add to tools catalog:** `agent/src/ai_agent/core/tools_catalog.py`

4. **Update template (if adding to default):** `config_service/templates/01_slack_incident_triage.json`

5. **Update customer docs:** `docs/CUSTOMER_INSTALLATION_GUIDE.md`

### New Agent

Agents are **dynamically constructed from JSON** - no code changes needed!

1. **Update team config in Config Service:**
   ```json
   {
     "agents": {
       "security_agent": {
         "model": "gpt-4o",
         "prompt": {
           "system": "You are an expert security analyst...",
           "instructions": [
             "Always check for CVEs",
             "Review security best practices"
           ]
         },
         "tools": ["scan_vulnerabilities", "check_cve_database"],
         "sub_agents": ["k8s_agent", "coding_agent"]
       }
     }
   }
   ```

2. **That's it!** Agent builder handles construction at runtime

### New Tool

1. **Create tool function with execution context:**
   ```python
   def my_tool(execution_context: Dict[str, Any], param: str) -> str:
       """Brief description for LLM.

       Args:
           execution_context: Runtime context (org_id, team_node_id, etc.)
           param: Parameter description

       Returns:
           JSON string: {"success": bool, "result": any, "error": str}
       """
       org_id = execution_context.get("org_id")
       team_node_id = execution_context.get("team_node_id")

       try:
           # Implementation
           result = do_something(param)
           return json.dumps({"success": True, "result": result})
       except Exception as e:
           return json.dumps({"success": False, "error": str(e)})
   ```

2. **Add to tools catalog with metadata**

3. **Write tests:** `tests/unit/tools/test_my_tool.py`

### New Webhook

1. **Add to orchestrator router:** `orchestrator/src/incidentfox_orchestrator/webhooks/router.py`

2. **Implement signature verification:**
   ```python
   @router.post("/webhooks/my_service")
   async def my_service_webhook(request: Request):
       # 1. Verify signature (service-specific)
       # 2. Parse payload
       # 3. Extract routing identifiers
       # 4. Look up team via Config Service
       # 5. Trigger agent run with context
       # 6. Return 200 OK immediately (don't wait for agent)
   ```

3. **Add secret to external-secrets:** `charts/incidentfox/templates/external-secrets.yaml`

4. **Update customer docs** with webhook URL and setup instructions

---

## üìã Code Conventions

### Python Services (agent, config_service, orchestrator)

- **Dependency management:** Poetry (NOT pip directly)
- **Style:** Black formatter, line length 120
- **Type hints:** Required for all public functions
- **Imports:** Absolute imports only, no relative
- **Error handling:** Always return JSON `{"success": bool, "result": any, "error": str}`
- **Logging:** Structured logging with correlation_id
- **Tests:** pytest with fixtures in conftest.py

### Next.js Web UI

- **Package manager:** pnpm (NOT npm or yarn - pnpm-lock.yaml is committed)
- **Style:** TypeScript strict mode, ESLint rules enforced
- **API routes:** Always proxy to backend, never direct calls from browser
- **Auth:** Cookie-based (`incidentfox_session_token` httpOnly cookie)
- **Components:** Use shadcn/ui components
- **State:** React hooks, avoid external state management

### Database Migrations

- **Always use Alembic** for schema changes
- **Never modify existing migrations** - create new ones
- **Test migrations:** Both upgrade and downgrade
- **Include data migrations:** When changing structure
- **Document breaking changes:** In migration message

---

## üìù File Editing Rules

1. **Always read files before editing**
   - Use Read tool to view current content
   - Understand existing structure and patterns

2. **Use Edit tool for existing files, never Write**
   - Edit tool preserves formatting and context
   - Write tool overwrites entire file (dangerous)

3. **Never create documentation files proactively**
   - Don't create README.md or *.md without explicit request
   - Only create when user explicitly asks

4. **No emojis unless requested**
   - Code and docs should be professional
   - Emojis only if user explicitly wants them

5. **Preserve exact indentation**
   - Match existing file's tab/space style
   - Pay attention to line numbers vs content

6. **Absolute paths only**
   - Never use relative paths in code
   - Example: Use `/Users/apple/Desktop/mono-repo/agent/...`

---

## üìñ Documentation Maintenance

### When to Update Docs

- **DEVELOPMENT_KNOWLEDGE.md** ‚Üí Major architectural changes
- **Service READMEs** ‚Üí Service-specific feature additions
- **CUSTOMER_*.md** ‚Üí Any customer-visible changes
- **docs/TECH_DEBT.md** ‚Üí New TODOs or completed items

### What NOT to Put in Docs

- ‚ùå Temporary debugging notes
- ‚ùå Historical planning ("day 1 we plan X, day 2 we did it")
- ‚ùå Already-resolved issues
- ‚ùå Duplicate information

### Documentation Style

- ‚úÖ Clear, concise language
- ‚úÖ Include code examples
- ‚úÖ Link to related docs
- ‚úÖ Commands are copy-pasteable
- ‚úÖ Use tables for structured data
- ‚úÖ Include "Last Updated" dates

---

## üß™ Testing & Validation

### Before Every Deployment

```bash
# 1. Run tests locally
cd agent && poetry run pytest
cd config_service && pytest

# 2. Build Docker image
docker build --platform linux/amd64 -t test:latest .

# 3. Test health endpoint
curl http://localhost:8080/health

# 4. After deployment: verify rollout
kubectl rollout status deployment/... -n incidentfox --timeout=90s
kubectl get pods -n incidentfox
```

### Evaluation Framework

After agent changes:

```bash
python3 scripts/eval_agent_performance.py

# Target: ‚â•85 average score, <60s per scenario
# Scenarios: healthCheck, cartCrash, adCrash, cartFailure, etc.
```

### Manual Testing Checklist

- [ ] Helm chart lints: `helm lint charts/incidentfox`
- [ ] All pods ready: `kubectl get pods -n incidentfox`
- [ ] Health endpoints: `curl https://orchestrator.incidentfox.ai/health`
- [ ] Web UI loads: `https://ui.incidentfox.ai`
- [ ] Can create agent run
- [ ] Webhooks trigger correctly

---

## üîí Security & Best Practices

### Secrets Management

- **NEVER commit secrets to git**
- Use Kubernetes secrets for all credentials
- Use AWS Secrets Manager for external secrets
- Rotate credentials regularly
- Environment variables only, never hardcode

### API Security

- Always verify webhook signatures
- Use bearer token authentication
- Implement rate limiting
- Log authentication failures
- Validate all input

### Database Security

- Use SQLAlchemy ORM (parameterized queries)
- Never construct SQL with string concatenation
- Implement row-level security for multi-tenancy
- Use connection pooling
- Enable SSL/TLS for connections

---

## üö® Common Pitfalls & Fixes

| Problem | Cause | Fix |
|---------|-------|-----|
| **ImagePullBackOff** | Docker auth failed | Recreate imagePullSecret |
| **CrashLoopBackOff** | Pod failing on startup | Check logs, verify env vars |
| **503 errors** | Readiness probe failing | Check /health endpoint |
| **JSONB not saving** | In-place modifications | Use `flag_modified(obj, 'config_json')` |
| **Max turns exceeded** | Agent timeout too low | Increase max_turns (currently 50) |
| **OOM during build** | Not enough Docker memory | Increase to 12+ GB in settings |

---

## ‚úÖ Deployment Checklist

Before deploying to production:

- [ ] Code reviewed by at least one developer
- [ ] Tests passing (pytest + eval framework)
- [ ] Documentation updated (if applicable)
- [ ] Database migrations tested (if applicable)
- [ ] Docker builds with `--platform linux/amd64`
- [ ] Health endpoint returns 200
- [ ] Helm chart validates
- [ ] Customer docs updated (if customer-visible)
- [ ] Rollback plan documented

---

## üìä Customer Impact Assessment

Before making changes:

1. **Breaking changes?** ‚Üí Requires customer migration guide
2. **New secrets?** ‚Üí Update CUSTOMER_INSTALLATION_GUIDE.md
3. **API changes?** ‚Üí Update API documentation
4. **New integrations?** ‚Üí Update setup instructions
5. **Performance impact?** ‚Üí Test with production-like load

---

## üîó Related Repositories

- **aws-playground** - OTEL demo microservices for fault injection
  - https://github.com/incidentfox/aws-playground
  - Deployed to same AWS environment

- **simple-fullstack-demo** - Git-related agent testing
  - https://github.com/incidentfox/simple-fullstack-demo
  - Test GitHub integration features

- **incidentfox-vendor-service** - License validation & telemetry
  - https://github.com/incidentfox/incidentfox-vendor-service
  - AWS Lambda deployment
  - https://vendor.incidentfox.ai

- **website** - Marketing site
  - https://github.com/incidentfox/website
  - https://incidentfox.ai

---

## üí° Remember

This is a **production system** used by **real customers** in **production environments**.

Every change must be:
- ‚úÖ Well-tested
- ‚úÖ Backwards compatible
- ‚úÖ Documented
- ‚úÖ Secure
- ‚úÖ Enterprise-quality

**When in doubt, ask for clarification rather than making assumptions.**

---

## üÜò Support & Questions

- **Full dev reference:** [DEVELOPMENT_KNOWLEDGE.md](DEVELOPMENT_KNOWLEDGE.md)
- **Architecture decisions:** [docs/ARCHITECTURE_DECISIONS.md](docs/ARCHITECTURE_DECISIONS.md)
- **Tech debt tracker:** [docs/TECH_DEBT.md](docs/TECH_DEBT.md)
- **Operations guide:** [docs/OPERATIONS.md](docs/OPERATIONS.md)
- **Customer docs:** [docs/CUSTOMER_ONBOARDING_README.md](docs/CUSTOMER_ONBOARDING_README.md)

