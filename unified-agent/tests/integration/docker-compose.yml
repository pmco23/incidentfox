# Integration test environment for unified-agent
#
# Usage:
#   docker-compose -f tests/integration/docker-compose.yml up --build
#
# This sets up:
# - unified-agent sandbox server on port 8888
# - Mock incident data mounted at /workspace

services:
  unified-agent:
    build:
      context: ../..
      dockerfile: Dockerfile
      target: development
    ports:
      - "8888:8888"
    environment:
      # Use a mock API key for testing (LiteLLM will use this)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-test-key}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-test-key}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-test-key}
      # Model selection
      - LLM_MODEL=${LLM_MODEL:-anthropic/claude-sonnet-4-20250514}
      # Tenant context
      - INCIDENTFOX_TENANT_ID=test-tenant
      - INCIDENTFOX_TEAM_ID=test-team
      - THREAD_ID=integration-test
    volumes:
      # Mount mock incident data
      - ./mock_data:/workspace/incident
      - ./mock_data/logs:/var/log/app
    command: ["python", "-m", "unified_agent.sandbox.server"]
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8888/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  # Mock service that generates logs/metrics for testing
  mock-service:
    image: python:3.11-slim
    volumes:
      - ./mock_data:/data
    command: >
      python -c "
      import json
      import time
      from datetime import datetime

      # Generate mock pod crash logs
      logs = [
          {'timestamp': '2024-01-15T10:00:00Z', 'level': 'INFO', 'message': 'Service starting...'},
          {'timestamp': '2024-01-15T10:00:05Z', 'level': 'INFO', 'message': 'Connected to database'},
          {'timestamp': '2024-01-15T10:05:00Z', 'level': 'WARN', 'message': 'High memory usage: 85%'},
          {'timestamp': '2024-01-15T10:10:00Z', 'level': 'ERROR', 'message': 'OOMKilled: Container exceeded memory limit'},
          {'timestamp': '2024-01-15T10:10:01Z', 'level': 'ERROR', 'message': 'Container terminated with exit code 137'},
      ]

      with open('/data/logs/app.log', 'w') as f:
          for log in logs:
              f.write(json.dumps(log) + '\n')

      # Generate mock k8s events
      events = {
          'items': [
              {'reason': 'Scheduled', 'message': 'Pod scheduled on node-1', 'timestamp': '2024-01-15T10:00:00Z'},
              {'reason': 'Pulled', 'message': 'Container image pulled successfully', 'timestamp': '2024-01-15T10:00:02Z'},
              {'reason': 'Started', 'message': 'Container started', 'timestamp': '2024-01-15T10:00:05Z'},
              {'reason': 'OOMKilling', 'message': 'Container exceeded memory limit (512Mi)', 'timestamp': '2024-01-15T10:10:00Z'},
              {'reason': 'BackOff', 'message': 'Back-off restarting failed container', 'timestamp': '2024-01-15T10:10:30Z'},
          ]
      }

      with open('/data/k8s_events.json', 'w') as f:
          json.dump(events, f, indent=2)

      # Generate mock pod describe
      pod_describe = '''
      Name:         payment-service-7d8f9c6b4-x2k9p
      Namespace:    production
      Status:       CrashLoopBackOff
      Containers:
        payment-api:
          State:          Waiting
            Reason:       CrashLoopBackOff
          Last State:     Terminated
            Reason:       OOMKilled
            Exit Code:    137
          Limits:
            memory:  512Mi
          Requests:
            memory:  256Mi
      Events:
        Type     Reason     Message
        ----     ------     -------
        Normal   Scheduled  Pod scheduled on node-1
        Normal   Pulled     Container image pulled
        Warning  OOMKilling Container exceeded memory limit
        Warning  BackOff    Back-off restarting failed container
      '''

      with open('/data/pod_describe.txt', 'w') as f:
          f.write(pod_describe)

      print('Mock incident data generated!')
      time.sleep(3600)  # Keep container alive
      "
