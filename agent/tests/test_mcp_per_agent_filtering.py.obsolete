"""
Test per-agent MCP tool filtering.

This test verifies that agents only receive the tools they're configured to have
access to based on the agent_tool_assignments configuration.
"""

import asyncio
import pytest
from unittest.mock import Mock, patch
from ai_agent.core.mcp_client import (
    initialize_mcp_servers,
    get_mcp_tools_for_agent,
    cleanup_mcp_connections,
)


@pytest.mark.asyncio
async def test_per_agent_tool_filtering_wildcard():
    """
    Test that agents with wildcard (*) get all MCP tools.
    """
    team_config = {
        "team_id": "test-wildcard-team",
        "mcp_servers": [
            {
                "id": "filesystem-mcp",
                "name": "Filesystem MCP",
                "type": "stdio",
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-filesystem", "/tmp"],
                "env": {},
                "enabled": True,
            }
        ],
        "team_added_mcp_servers": [],
        "team_disabled_tool_ids": [],
        "agent_tool_assignments": {
            "planner": {
                "mcp_tools": ["*"]  # Wildcard - gets all tools
            }
        }
    }

    try:
        # Initialize MCP servers
        await initialize_mcp_servers(team_config)

        # Mock config to return our team_config
        with patch('ai_agent.core.mcp_client.get_config') as mock_config:
            mock_config_obj = Mock()
            mock_config_obj.team_config = team_config
            mock_config.return_value = mock_config_obj

            # Get tools for planner (should get all)
            planner_tools = get_mcp_tools_for_agent("test-wildcard-team", "planner")

            assert len(planner_tools) > 0, "Planner should get tools with wildcard"
            print(f"✅ Planner with wildcard got {len(planner_tools)} tools")

    finally:
        await cleanup_mcp_connections("test-wildcard-team")


@pytest.mark.asyncio
async def test_per_agent_tool_filtering_specific_patterns():
    """
    Test that agents only get tools matching specific patterns.
    """
    team_config = {
        "team_id": "test-pattern-team",
        "mcp_servers": [
            {
                "id": "filesystem-mcp",
                "name": "Filesystem MCP",
                "type": "stdio",
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-filesystem", "/tmp"],
                "env": {},
                "enabled": True,
            }
        ],
        "team_added_mcp_servers": [],
        "team_disabled_tool_ids": [],
        "agent_tool_assignments": {
            "k8s_agent": {
                "mcp_tools": ["filesystem_mcp__read_*", "filesystem_mcp__list_*"]
            }
        }
    }

    try:
        # Initialize MCP servers
        all_tools = await initialize_mcp_servers(team_config)
        print(f"Total tools discovered: {len(all_tools)}")

        # Mock config
        with patch('ai_agent.core.mcp_client.get_config') as mock_config:
            mock_config_obj = Mock()
            mock_config_obj.team_config = team_config
            mock_config.return_value = mock_config_obj

            # Get tools for k8s_agent (should only get read_ and list_ tools)
            k8s_tools = get_mcp_tools_for_agent("test-pattern-team", "k8s_agent")

            # Verify filtering worked
            assert len(k8s_tools) < len(all_tools), "K8s agent should get fewer tools than total"

            for tool in k8s_tools:
                assert ("read_" in tool.__name__ or "list_" in tool.__name__), \
                    f"Tool {tool.__name__} should match pattern"

            print(f"✅ K8s agent got {len(k8s_tools)} filtered tools out of {len(all_tools)} total")

    finally:
        await cleanup_mcp_connections("test-pattern-team")


@pytest.mark.asyncio
async def test_per_agent_tool_filtering_no_restrictions():
    """
    Test that agents without specific assignments get all tools.
    """
    team_config = {
        "team_id": "test-no-restriction-team",
        "mcp_servers": [
            {
                "id": "filesystem-mcp",
                "name": "Filesystem MCP",
                "type": "stdio",
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-filesystem", "/tmp"],
                "env": {},
                "enabled": True,
            }
        ],
        "team_added_mcp_servers": [],
        "team_disabled_tool_ids": [],
        "agent_tool_assignments": {
            "planner": {
                "mcp_tools": ["*"]
            }
            # investigation agent not listed - should get all tools
        }
    }

    try:
        # Initialize MCP servers
        all_tools = await initialize_mcp_servers(team_config)

        # Mock config
        with patch('ai_agent.core.mcp_client.get_config') as mock_config:
            mock_config_obj = Mock()
            mock_config_obj.team_config = team_config
            mock_config.return_value = mock_config_obj

            # Get tools for investigation (not in assignments - should get all)
            investigation_tools = get_mcp_tools_for_agent("test-no-restriction-team", "investigation")

            assert len(investigation_tools) == len(all_tools), \
                "Agent without restrictions should get all tools"

            print(f"✅ Investigation agent (no restrictions) got all {len(investigation_tools)} tools")

    finally:
        await cleanup_mcp_connections("test-no-restriction-team")


@pytest.mark.asyncio
async def test_per_agent_tool_filtering_multiple_patterns():
    """
    Test multiple tool patterns for an agent.
    """
    team_config = {
        "team_id": "test-multi-pattern-team",
        "mcp_servers": [
            {
                "id": "filesystem-mcp",
                "name": "Filesystem MCP",
                "type": "stdio",
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-filesystem", "/tmp"],
                "env": {},
                "enabled": True,
            }
        ],
        "team_added_mcp_servers": [],
        "team_disabled_tool_ids": [],
        "agent_tool_assignments": {
            "coding_agent": {
                "mcp_tools": [
                    "filesystem_mcp__read_file",
                    "filesystem_mcp__write_file",
                    "filesystem_mcp__list_directory"
                ]
            }
        }
    }

    try:
        # Initialize MCP servers
        all_tools = await initialize_mcp_servers(team_config)

        # Mock config
        with patch('ai_agent.core.mcp_client.get_config') as mock_config:
            mock_config_obj = Mock()
            mock_config_obj.team_config = team_config
            mock_config.return_value = mock_config_obj

            # Get tools for coding_agent
            coding_tools = get_mcp_tools_for_agent("test-multi-pattern-team", "coding_agent")

            # Verify only specified tools are included
            coding_tool_names = [t.__name__ for t in coding_tools]

            allowed_tools = [
                "filesystem_mcp__read_file",
                "filesystem_mcp__write_file",
                "filesystem_mcp__list_directory"
            ]

            for tool_name in coding_tool_names:
                assert tool_name in allowed_tools, \
                    f"Tool {tool_name} should be in allowed list"

            print(f"✅ Coding agent got {len(coding_tools)} specific tools")
            print(f"   Allowed tools: {coding_tool_names}")

    finally:
        await cleanup_mcp_connections("test-multi-pattern-team")


if __name__ == "__main__":
    """
    Run tests manually for development.

    Usage:
        cd agent
        python -m pytest tests/test_mcp_per_agent_filtering.py -v -s
    """
    print("=" * 60)
    print("MCP Per-Agent Tool Filtering Tests")
    print("=" * 60)

    async def run_all_tests():
        print("\n1. Testing wildcard pattern...")
        await test_per_agent_tool_filtering_wildcard()

        print("\n2. Testing specific patterns...")
        await test_per_agent_tool_filtering_specific_patterns()

        print("\n3. Testing no restrictions...")
        await test_per_agent_tool_filtering_no_restrictions()

        print("\n4. Testing multiple patterns...")
        await test_per_agent_tool_filtering_multiple_patterns()

        print("\n" + "=" * 60)
        print("✅ All filtering tests passed!")
        print("=" * 60)

    asyncio.run(run_all_tests())
