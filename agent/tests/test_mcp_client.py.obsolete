"""
Test MCP client implementation.

This test verifies that the MCP client can connect to MCP servers,
discover tools, and call them successfully.
"""

import asyncio
import pytest
from ai_agent.core.mcp_client import (
    initialize_mcp_servers,
    get_mcp_tools_for_agent,
    cleanup_mcp_connections,
    get_active_mcp_servers,
    get_mcp_tool_count,
)


@pytest.mark.asyncio
async def test_mcp_filesystem_server():
    """
    Test connecting to the filesystem MCP server.

    This test requires npx to be available in the environment.
    """
    team_config = {
        "team_id": "test-team",
        "mcp_servers": [
            {
                "id": "filesystem-mcp",
                "name": "Filesystem MCP",
                "type": "stdio",
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-filesystem", "/tmp"],
                "env": {},
                "enabled": True,
            }
        ],
        "team_added_mcp_servers": [],
        "team_disabled_tool_ids": [],
    }

    try:
        # Initialize MCP servers
        tools = await initialize_mcp_servers(team_config)

        # Verify tools were discovered
        assert len(tools) > 0, "No tools discovered from filesystem MCP"
        print(f"✅ Discovered {len(tools)} tools from filesystem MCP")

        # Check active servers
        active_servers = get_active_mcp_servers("test-team")
        assert "filesystem-mcp" in active_servers
        print(f"✅ Active MCP servers: {active_servers}")

        # Check tool count
        tool_count = get_mcp_tool_count("test-team")
        assert tool_count == len(tools)
        print(f"✅ Tool count matches: {tool_count}")

        # Verify tools have correct metadata
        for tool in tools:
            assert hasattr(tool, "__name__"), "Tool missing __name__"
            assert hasattr(tool, "__doc__"), "Tool missing __doc__"
            assert hasattr(tool, "_is_mcp_tool"), "Tool missing _is_mcp_tool marker"
            assert hasattr(tool, "_mcp_id"), "Tool missing _mcp_id"
            assert hasattr(tool, "_mcp_tool_name"), "Tool missing _mcp_tool_name"
            print(f"  - {tool.__name__}: {tool.__doc__[:60]}...")

        # Test calling a tool (list_directory)
        list_dir_tool = next((t for t in tools if "list" in t.__name__.lower()), None)
        if list_dir_tool:
            print(f"\n✅ Testing tool call: {list_dir_tool.__name__}")
            result = await list_dir_tool(path="/tmp")
            assert result is not None, "Tool call returned None"
            assert len(result) > 0, "Tool call returned empty result"
            print(f"✅ Tool call successful, result length: {len(result)} chars")

    finally:
        # Cleanup
        await cleanup_mcp_connections("test-team")
        print("\n✅ Cleanup completed")


@pytest.mark.asyncio
async def test_mcp_multiple_servers():
    """
    Test connecting to multiple MCP servers simultaneously.
    """
    team_config = {
        "team_id": "multi-test-team",
        "mcp_servers": [
            {
                "id": "filesystem-mcp-1",
                "name": "Filesystem MCP 1",
                "type": "stdio",
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-filesystem", "/tmp"],
                "env": {},
                "enabled": True,
            },
            {
                "id": "filesystem-mcp-2",
                "name": "Filesystem MCP 2",
                "type": "stdio",
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-filesystem", "/var/tmp"],
                "env": {},
                "enabled": True,
            },
        ],
        "team_added_mcp_servers": [],
        "team_disabled_tool_ids": [],
    }

    try:
        # Initialize MCP servers
        tools = await initialize_mcp_servers(team_config)

        # Verify tools from both servers
        assert len(tools) > 0, "No tools discovered"
        print(f"✅ Discovered {len(tools)} total tools from 2 MCP servers")

        # Check both servers are active
        active_servers = get_active_mcp_servers("multi-test-team")
        assert len(active_servers) == 2, f"Expected 2 servers, got {len(active_servers)}"
        print(f"✅ Both servers active: {active_servers}")

    finally:
        await cleanup_mcp_connections("multi-test-team")
        print("✅ Cleanup completed")


@pytest.mark.asyncio
async def test_mcp_disabled_tools():
    """
    Test that disabled tools are filtered out.
    """
    team_config = {
        "team_id": "disabled-test-team",
        "mcp_servers": [
            {
                "id": "filesystem-mcp",
                "name": "Filesystem MCP",
                "type": "stdio",
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-filesystem", "/tmp"],
                "env": {},
                "enabled": True,
            }
        ],
        "team_added_mcp_servers": [],
        "team_disabled_tool_ids": ["filesystem-mcp"],  # Disable the entire MCP
    }

    try:
        # Initialize MCP servers
        tools = await initialize_mcp_servers(team_config)

        # No tools should be loaded (MCP is disabled)
        assert len(tools) == 0, "Tools were loaded from disabled MCP"
        print("✅ Disabled MCP correctly excluded")

    finally:
        await cleanup_mcp_connections("disabled-test-team")


@pytest.mark.asyncio
async def test_mcp_invalid_config():
    """
    Test handling of invalid MCP configuration.
    """
    team_config = {
        "team_id": "invalid-test-team",
        "mcp_servers": [
            {
                "id": "invalid-mcp",
                "name": "Invalid MCP",
                "type": "stdio",
                "command": "nonexistent-command",  # Invalid command
                "args": [],
                "env": {},
                "enabled": True,
            }
        ],
        "team_added_mcp_servers": [],
        "team_disabled_tool_ids": [],
    }

    try:
        # Initialize MCP servers
        tools = await initialize_mcp_servers(team_config)

        # Should handle error gracefully and return empty list
        assert len(tools) == 0, "Tools loaded from invalid MCP"
        print("✅ Invalid MCP configuration handled gracefully")

    finally:
        await cleanup_mcp_connections("invalid-test-team")


@pytest.mark.asyncio
async def test_get_mcp_tools_for_agent():
    """
    Test retrieving tools for a specific agent.
    """
    team_config = {
        "team_id": "agent-test-team",
        "mcp_servers": [
            {
                "id": "filesystem-mcp",
                "name": "Filesystem MCP",
                "type": "stdio",
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-filesystem", "/tmp"],
                "env": {},
                "enabled": True,
            }
        ],
        "team_added_mcp_servers": [],
        "team_disabled_tool_ids": [],
    }

    try:
        # Initialize MCP servers
        await initialize_mcp_servers(team_config)

        # Get tools for specific agent
        agent_tools = get_mcp_tools_for_agent("agent-test-team", "planner")
        assert len(agent_tools) > 0, "No tools returned for agent"
        print(f"✅ Retrieved {len(agent_tools)} tools for planner agent")

        # Verify tools are callable
        for tool in agent_tools:
            assert callable(tool), f"Tool {tool.__name__} is not callable"

    finally:
        await cleanup_mcp_connections("agent-test-team")


if __name__ == "__main__":
    """
    Run tests manually for development.

    Usage:
        cd agent
        python -m pytest tests/test_mcp_client.py -v -s

    Or run individually:
        python tests/test_mcp_client.py
    """
    print("=" * 60)
    print("MCP Client Integration Tests")
    print("=" * 60)

    async def run_all_tests():
        print("\n1. Testing filesystem MCP server connection...")
        await test_mcp_filesystem_server()

        print("\n2. Testing multiple MCP servers...")
        await test_mcp_multiple_servers()

        print("\n3. Testing disabled tools filtering...")
        await test_mcp_disabled_tools()

        print("\n4. Testing invalid configuration handling...")
        await test_mcp_invalid_config()

        print("\n5. Testing agent-specific tool retrieval...")
        await test_get_mcp_tools_for_agent()

        print("\n" + "=" * 60)
        print("✅ All tests passed!")
        print("=" * 60)

    asyncio.run(run_all_tests())
