version: '3.8'

# ═══════════════════════════════════════════════════════════════════════════════
# IncidentFox Local Trial Stack
# ═══════════════════════════════════════════════════════════════════════════════
#
# Pulls pre-built images from Docker Hub (incidentfox/).
# No source code required - just this file + .env + init.sql.
#
# Required services (default):
#   - postgres       PostgreSQL database
#   - config-service Team configuration, tokens, audit
#   - agent          Multi-agent AI execution
#
# Optional services (via profiles):
#   - web-ui         Browser-based config UI (--profile ui)
#   - raptor         RAPTOR Knowledge Base RAG (--profile raptor)
#
# Usage:
#   make start         Start required services
#   make start-ui      Start with Web UI
#   make start-raptor  Start with RAPTOR Knowledge Base
#   make start-all     Start with all optional services
#   make stop          Stop all services
#
# Image configuration:
#   INCIDENTFOX_REGISTRY  - Docker registry (default: incidentfox)
#   INCIDENTFOX_VERSION   - Image version (default: latest)
#
# ═══════════════════════════════════════════════════════════════════════════════

services:
  # ─────────────────────────────────────────────────────────────────────────────
  # PostgreSQL - Backend for config_service
  # ─────────────────────────────────────────────────────────────────────────────
  postgres:
    image: postgres:15-alpine
    container_name: incidentfox-postgres
    environment:
      POSTGRES_USER: incidentfox
      POSTGRES_PASSWORD: localdev
      POSTGRES_DB: incidentfox
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./config/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U incidentfox -d incidentfox"]
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  # ─────────────────────────────────────────────────────────────────────────────
  # Config Service - Team config, tokens, audit logging
  # ─────────────────────────────────────────────────────────────────────────────
  config-service:
    image: ${INCIDENTFOX_REGISTRY:-incidentfox}/config-service:${INCIDENTFOX_VERSION:-latest}
    container_name: incidentfox-config-service
    environment:
      # Database
      DATABASE_URL: postgresql+psycopg2://incidentfox:localdev@postgres:5432/incidentfox?sslmode=disable
      # Security
      TOKEN_PEPPER: ${TOKEN_PEPPER:-localdev-pepper-must-be-32-chars-min}
      ADMIN_TOKEN: ${ADMIN_TOKEN:-local-admin-token}
      ADMIN_AUTH_MODE: token
      TEAM_AUTH_MODE: token
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: console
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ─────────────────────────────────────────────────────────────────────────────
  # Agent Service - Multi-agent AI execution (Planner + sub-agents)
  # ─────────────────────────────────────────────────────────────────────────────
  agent:
    image: ${INCIDENTFOX_REGISTRY:-incidentfox}/agent:${INCIDENTFOX_VERSION:-latest}
    container_name: incidentfox-agent
    env_file:
      - .env
    environment:
      # Required: OpenAI
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}
      # Only set OPENAI_BASE_URL if you're using a custom endpoint (LiteLLM, Azure, etc.)
      # Config service integration
      USE_CONFIG_SERVICE: "true"
      CONFIG_BASE_URL: http://config-service:8080
      CONFIG_SERVICE_URL: http://config-service:8080
      # Auth (simplified for local)
      REQUIRE_AUTH: "false"
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: console
      ENVIRONMENT: development
      # Optional integrations (from .env)
      K8S_ENABLED: ${K8S_ENABLED:-false}
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN:-}
      GITHUB_TOKEN: ${GITHUB_TOKEN:-}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      DATADOG_API_KEY: ${DATADOG_API_KEY:-}
      DATADOG_APP_KEY: ${DATADOG_APP_KEY:-}
      GRAFANA_URL: ${GRAFANA_URL:-}
      GRAFANA_API_KEY: ${GRAFANA_API_KEY:-}
      CORALOGIX_API_KEY: ${CORALOGIX_API_KEY:-}
      ELASTICSEARCH_URL: ${ELASTICSEARCH_URL:-}
      ELASTICSEARCH_USERNAME: ${ELASTICSEARCH_USERNAME:-}
      ELASTICSEARCH_PASSWORD: ${ELASTICSEARCH_PASSWORD:-}
      # Jira
      JIRA_URL: ${JIRA_URL:-}
      JIRA_EMAIL: ${JIRA_EMAIL:-}
      JIRA_API_TOKEN: ${JIRA_API_TOKEN:-}
      # Sentry
      SENTRY_AUTH_TOKEN: ${SENTRY_AUTH_TOKEN:-}
      SENTRY_ORGANIZATION: ${SENTRY_ORGANIZATION:-}
      SENTRY_PROJECT: ${SENTRY_PROJECT:-}
      # GitLab
      GITLAB_TOKEN: ${GITLAB_TOKEN:-}
      GITLAB_URL: ${GITLAB_URL:-}
      # Confluence
      CONFLUENCE_URL: ${CONFLUENCE_URL:-}
      CONFLUENCE_USERNAME: ${CONFLUENCE_USERNAME:-}
      CONFLUENCE_API_TOKEN: ${CONFLUENCE_API_TOKEN:-}
      # Linear
      LINEAR_API_KEY: ${LINEAR_API_KEY:-}
      # Splunk
      SPLUNK_HOST: ${SPLUNK_HOST:-}
      SPLUNK_TOKEN: ${SPLUNK_TOKEN:-}
      # New Relic
      NEWRELIC_API_KEY: ${NEWRELIC_API_KEY:-}
      # PagerDuty
      PAGERDUTY_API_KEY: ${PAGERDUTY_API_KEY:-}
      # Notion
      NOTION_API_KEY: ${NOTION_API_KEY:-}
      # MS Teams
      MSTEAMS_WEBHOOK_URL: ${MSTEAMS_WEBHOOK_URL:-}
      # Sourcegraph
      SOURCEGRAPH_URL: ${SOURCEGRAPH_URL:-}
      SOURCEGRAPH_TOKEN: ${SOURCEGRAPH_TOKEN:-}
      # BigQuery
      BIGQUERY_PROJECT_ID: ${BIGQUERY_PROJECT_ID:-}
      BIGQUERY_DATASET: ${BIGQUERY_DATASET:-}
      # PostgreSQL (for postgres_tools, not the local DB)
      POSTGRES_TOOLS_URL: ${POSTGRES_TOOLS_URL:-}
      # Snowflake
      SNOWFLAKE_ACCOUNT: ${SNOWFLAKE_ACCOUNT:-}
      SNOWFLAKE_USER: ${SNOWFLAKE_USER:-}
      SNOWFLAKE_PASSWORD: ${SNOWFLAKE_PASSWORD:-}
      # RAPTOR Knowledge Base (if running with --profile raptor)
      RAPTOR_URL: ${RAPTOR_URL:-}
      RAPTOR_DEFAULT_TREE: ${RAPTOR_DEFAULT_TREE:-mega_ultra_v2}
    ports:
      - "8081:8080"
    depends_on:
      config-service:
        condition: service_healthy
    volumes:
      # Mount kubeconfig for K8s tools (if K8S_ENABLED=true)
      # Container HOME is /home/appuser, so mount there
      - ${HOME}/.kube:/home/appuser/.kube:ro
      # Mount AWS credentials (if AWS tools needed)
      - ${HOME}/.aws:/home/appuser/.aws:ro
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ─────────────────────────────────────────────────────────────────────────────
  # Web UI - Optional browser-based configuration (--profile ui)
  # ─────────────────────────────────────────────────────────────────────────────
  # ─────────────────────────────────────────────────────────────────────────────
  # RAPTOR Knowledge Base - Optional RAG service (--profile raptor)
  # ─────────────────────────────────────────────────────────────────────────────
  raptor:
    image: ${INCIDENTFOX_REGISTRY:-incidentfox}/raptor:${INCIDENTFOX_VERSION:-latest}
    container_name: incidentfox-raptor
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      RAPTOR_TREES_DIR: /app/trees
      RAPTOR_DEFAULT_TREE: ${RAPTOR_DEFAULT_TREE:-mega_ultra_v2}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "8000:8000"
    volumes:
      # Persist knowledge trees locally
      - raptor-trees:/app/trees
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    profiles:
      - raptor
    restart: unless-stopped

  # ─────────────────────────────────────────────────────────────────────────────
  # Web UI - Optional browser-based configuration (--profile ui)
  # ─────────────────────────────────────────────────────────────────────────────
  web-ui:
    image: ${INCIDENTFOX_REGISTRY:-incidentfox}/web-ui:${INCIDENTFOX_VERSION:-latest}
    container_name: incidentfox-web-ui
    environment:
      CONFIG_SERVICE_URL: http://config-service:8080
      ORCHESTRATOR_URL: ""
      RAPTOR_API_URL: ${RAPTOR_URL:-}
      WEB_UI_COOKIE_SECURE: "0"
      NEXT_PUBLIC_WEB_UI_OIDC_ENABLED: "0"
      WEB_UI_OIDC_ENABLED: "0"
    ports:
      - "3000:3000"
    depends_on:
      - config-service
    profiles:
      - ui
    restart: unless-stopped

volumes:
  postgres-data:
    name: incidentfox-postgres-data
  raptor-trees:
    name: incidentfox-raptor-trees
