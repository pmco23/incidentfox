---
# Horizontal Pod Autoscaler for Server
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: incidentfox-server-hpa
  namespace: incidentfox-prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: incidentfox-server
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300  # Wait 5 min before scaling down
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0  # Scale up immediately
      policies:
      - type: Percent
        value: 100
        periodSeconds: 30
---
# Horizontal Pod Autoscaler for Router
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: sandbox-router-hpa
  namespace: incidentfox-prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: sandbox-router-deployment
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300  # Wait 5 min before scaling down
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0  # Scale up immediately
      policies:
      - type: Percent
        value: 100
        periodSeconds: 30
---
# Cluster Autoscaler
# Automatically installed by scripts/setup-prod.sh
# Scales nodes from 2-6 based on pod resource requests
#
# Manual installation (if needed):
# helm repo add autoscaler https://kubernetes.github.io/autoscaler
# helm upgrade --install cluster-autoscaler autoscaler/cluster-autoscaler \
#   --namespace kube-system \
#   --set autoDiscovery.clusterName=incidentfox-prod \
#   --set awsRegion=us-west-2

