---
# Server Deployment - FastAPI server that orchestrates investigations
apiVersion: apps/v1
kind: Deployment
metadata:
  name: incidentfox-server
  namespace: incidentfox-prod
  labels:
    app: incidentfox-server
spec:
  replicas: 2
  selector:
    matchLabels:
      app: incidentfox-server
  template:
    metadata:
      labels:
        app: incidentfox-server
    spec:
      serviceAccountName: incidentfox-server
      imagePullSecrets:
      - name: ecr-registry-secret
      containers:
      - name: server
        # Image tag is updated by deploy script using kubectl set image
        # Default :latest is only used if deployment is applied manually
        image: 103002841599.dkr.ecr.us-west-2.amazonaws.com/incidentfox-agent:latest
        imagePullPolicy: Always
        command: ["python", "/app/server.py"]
        ports:
        - containerPort: 8000
          name: http
        env:
        - name: SANDBOX_IMAGE
          # Updated by deploy script to match server image tag
          value: "103002841599.dkr.ecr.us-west-2.amazonaws.com/incidentfox-agent:latest"
        - name: SANDBOX_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace  # Use same namespace as server
        - name: USE_GVISOR
          value: "true"  # Production uses gVisor for enhanced isolation
        - name: CREDENTIAL_RESOLVER_NAMESPACE
          value: "incidentfox-prod"  # Where credential-resolver service runs
        # JWT secret for signing tokens passed to sandboxes (required)
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: incidentfox-secrets
              key: jwt-secret
        # Laminar API key for OUR observability tracing (required for telemetry)
        - name: LMNR_PROJECT_API_KEY
          valueFrom:
            secretKeyRef:
              name: incidentfox-secrets
              key: laminar-api-key
        # Note: Customer API keys (Anthropic, Coralogix, etc.) are NOT needed here.
        # Sandboxes get credentials from credential-resolver at runtime via envoy sidecar.
        resources:
          requests:
            cpu: "250m"
            memory: "512Mi"
          limits:
            cpu: "1000m"
            memory: "1Gi"
        readinessProbe:
          httpGet:
            path: /docs
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 5
        livenessProbe:
          httpGet:
            path: /docs
            port: 8000
          initialDelaySeconds: 20
          periodSeconds: 10
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
---
# Service for the server - ClusterIP (internal only)
# Only accessible from within the cluster (via slack-bot)
apiVersion: v1
kind: Service
metadata:
  name: incidentfox-server-svc
  namespace: incidentfox-prod
spec:
  type: ClusterIP  # Internal only - accessed via slack-bot
  selector:
    app: incidentfox-server
  ports:
  - name: http
    port: 8000
    targetPort: 8000
    protocol: TCP
---
# ServiceAccount with K8s API permissions
apiVersion: v1
kind: ServiceAccount
metadata:
  name: incidentfox-server
  namespace: incidentfox-prod
---
# Role to manage Sandboxes (same namespace as server)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: incidentfox-server-role
  namespace: incidentfox-prod
rules:
- apiGroups: ["agents.x-k8s.io"]
  resources: ["sandboxes"]
  verbs: ["get", "list", "watch", "create", "delete"]
- apiGroups: [""]
  resources: ["pods", "services"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["pods/log"]
  verbs: ["get"]
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "create", "update", "delete"]  # For per-sandbox Envoy configs
---
# RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: incidentfox-server-binding
  namespace: incidentfox-prod
subjects:
- kind: ServiceAccount
  name: incidentfox-server
  namespace: incidentfox-prod
roleRef:
  kind: Role
  name: incidentfox-server-role
  apiGroup: rbac.authorization.k8s.io
