# CronJob to clean up expired sandboxes
# The agent-sandbox controller doesn't enforce TTL (shutdownTime field),
# so we need this job to prevent resource exhaustion from accumulated sandboxes.
#
# Runs every 15 minutes, deletes sandboxes where shutdownTime has passed.
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: sandbox-cleanup
  namespace: incidentfox-prod
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: sandbox-cleanup
  namespace: incidentfox-prod
rules:
  - apiGroups: ["agents.x-k8s.io"]
    resources: ["sandboxes"]
    verbs: ["get", "list", "delete"]
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: sandbox-cleanup
  namespace: incidentfox-prod
subjects:
  - kind: ServiceAccount
    name: sandbox-cleanup
    namespace: incidentfox-prod
roleRef:
  kind: Role
  name: sandbox-cleanup
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: sandbox-cleanup
  namespace: incidentfox-prod
spec:
  schedule: "*/15 * * * *"  # Every 15 minutes
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 3600  # Clean up job pods after 1 hour
      template:
        spec:
          serviceAccountName: sandbox-cleanup
          restartPolicy: OnFailure
          containers:
            - name: cleanup
              image: bitnami/kubectl:latest
              command:
                - /bin/bash
                - -c
                - |
                  set -e

                  echo "=== Sandbox Cleanup Job Started ==="
                  echo "Current time: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

                  # Get current time in seconds since epoch
                  NOW=$(date +%s)

                  # List all sandboxes with their shutdownTime
                  echo ""
                  echo "Checking sandboxes for expired TTL..."

                  DELETED=0
                  KEPT=0

                  # Get all sandboxes as JSON and process
                  kubectl get sandbox -n incidentfox-prod -o json | \
                  jq -r '.items[] | "\(.metadata.name) \(.spec.shutdownTime // "none")"' | \
                  while read -r NAME SHUTDOWN; do
                    if [ "$SHUTDOWN" = "none" ] || [ -z "$SHUTDOWN" ]; then
                      echo "  SKIP: $NAME (no shutdownTime set)"
                      continue
                    fi

                    # Convert shutdownTime to seconds since epoch
                    SHUTDOWN_EPOCH=$(date -d "$SHUTDOWN" +%s 2>/dev/null || echo "0")

                    if [ "$SHUTDOWN_EPOCH" = "0" ]; then
                      echo "  WARN: $NAME (invalid shutdownTime: $SHUTDOWN)"
                      continue
                    fi

                    if [ "$NOW" -gt "$SHUTDOWN_EPOCH" ]; then
                      echo "  DELETE: $NAME (expired at $SHUTDOWN)"
                      kubectl delete sandbox "$NAME" -n incidentfox-prod --wait=false || true

                      # Also clean up associated ConfigMap
                      kubectl delete configmap "envoy-config-$NAME" -n incidentfox-prod --ignore-not-found=true || true

                      DELETED=$((DELETED + 1))
                    else
                      REMAINING=$((SHUTDOWN_EPOCH - NOW))
                      echo "  KEEP: $NAME (expires in ${REMAINING}s)"
                      KEPT=$((KEPT + 1))
                    fi
                  done

                  echo ""
                  echo "=== Cleanup Complete ==="
                  echo "Sandboxes remaining: $(kubectl get sandbox -n incidentfox-prod --no-headers 2>/dev/null | wc -l)"
              resources:
                requests:
                  cpu: 50m
                  memory: 64Mi
                limits:
                  cpu: 200m
                  memory: 128Mi
