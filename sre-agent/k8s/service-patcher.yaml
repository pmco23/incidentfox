apiVersion: v1
kind: ServiceAccount
metadata:
  name: sandbox-service-patcher
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: sandbox-service-patcher
rules:
- apiGroups: [""]
  resources: ["services"]
  verbs: ["get", "list", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: sandbox-service-patcher
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: sandbox-service-patcher
subjects:
- kind: ServiceAccount
  name: sandbox-service-patcher
  namespace: default
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sandbox-service-patcher
  namespace: default
  labels:
    app: sandbox-service-patcher
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sandbox-service-patcher
  template:
    metadata:
      labels:
        app: sandbox-service-patcher
    spec:
      serviceAccountName: sandbox-service-patcher
      containers:
      - name: patcher
        image: bitnami/kubectl:latest
        command: ["/bin/bash", "-c"]
        args:
        - |
          echo "ðŸ‘ï¸  Watching for sandbox services to patch..."
          
          while true; do
            # Get all services for investigation sandboxes (in all namespaces)
            SERVICES=$(kubectl get svc --all-namespaces -l 'agents.x-k8s.io/sandbox-name-hash' -o jsonpath='{range .items[*]}{.metadata.namespace}/{.metadata.name}{"\n"}{end}' 2>/dev/null || true)
            
            for SVC_PATH in $SERVICES; do
              NAMESPACE=$(echo $SVC_PATH | cut -d'/' -f1)
              SVC=$(echo $SVC_PATH | cut -d'/' -f2)
              
              # Check if service has ports defined
              PORTS=$(kubectl get svc $SVC -n $NAMESPACE -o jsonpath='{.spec.ports}' 2>/dev/null || echo "[]")
              
              if [ "$PORTS" == "[]" ] || [ "$PORTS" == "null" ] || [ -z "$PORTS" ]; then
                echo "ðŸ”§ Patching service $SVC in namespace $NAMESPACE (missing ports)"
                kubectl patch svc $SVC -n $NAMESPACE --type='json' -p='[{"op": "add", "path": "/spec/ports", "value": [{"name": "sandbox", "port": 8888, "protocol": "TCP", "targetPort": 8888}]}]' 2>/dev/null || true
              fi
            done
            
            sleep 5
          done
        resources:
          requests:
            cpu: 10m
            memory: 32Mi
          limits:
            cpu: 100m
            memory: 128Mi
      restartPolicy: Always

