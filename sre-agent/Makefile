.PHONY: help

help: ## Show available commands
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘           SRE Agent - IncidentFox Investigation               â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸ  LOCAL DEVELOPMENT"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@grep -E '^[a-zA-Z_-]+:.*?## ğŸ .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-25s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "â˜ï¸  PRODUCTION"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@grep -E '^[a-zA-Z_-]+:.*?## â˜ï¸.*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-25s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ğŸ“Š UTILITIES"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@grep -E '^[a-zA-Z_-]+:.*?## ğŸ“Š.*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-25s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "For more details, see: DEPLOYMENT_QUICK_START.md"
	@echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ  LOCAL DEVELOPMENT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

setup-local: ## ğŸ  First-time local setup (creates Kind cluster, installs components)
	@./scripts/setup-local.sh

dev: ## ğŸ  Start local dev environment (docker-compose-like, Ctrl+C to stop)
	@./scripts/dev.sh

test-local: ## ğŸ  Quick test agent locally (no K8s, fast iteration)
	@echo "ğŸ’¡ Usage: make test-local PROMPT='your question here'"
	@echo ""
	@uv run python test_local.py "$(PROMPT)"

dev-clean: ## ğŸ  Clean up local sandboxes manually
	@echo "ğŸ§¹ Cleaning up..."
	@if ! kubectl config current-context | grep -q "kind-incidentfox"; then \
		kubectl config use-context kind-incidentfox 2>/dev/null || true; \
	fi
	@kubectl delete sandbox --all --timeout=30s 2>/dev/null || true
	@echo "âœ… Cleaned"

dev-reset: ## ğŸ  Delete Kind cluster and start fresh (nuclear option)
	@echo "â˜¢ï¸  This will DELETE the entire Kind cluster!"
	@read -p "Continue? (y/N) " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		kind delete cluster --name incidentfox || true; \
		echo "âœ… Deleted. Run 'make setup-local' to recreate"; \
	fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# â˜ï¸  PRODUCTION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

setup-prod: ## â˜ï¸ First-time production setup (creates EKS cluster, installs components)
	@./scripts/setup-prod.sh

deploy-prod: ## â˜ï¸ Deploy to production (builds multi-platform, pushes to ECR, deploys)
	@./scripts/deploy-prod.sh

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“Š UTILITIES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

dev-status: ## ğŸ“Š Show status of local dev environment
	@echo "ğŸ“Š Local Development Status"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo ""
	@echo "Context: $$(kubectl config current-context 2>/dev/null || echo 'None')"
	@echo ""
	@echo "Controller:"
	@kubectl get statefulset -n agent-sandbox-system agent-sandbox-controller 2>/dev/null || echo "  âŒ Not running (run: make setup-local)"
	@echo ""
	@echo "Router:"
	@kubectl get deployment sandbox-router-deployment 2>/dev/null || echo "  âŒ Not running (run: make setup-local)"
	@echo ""
	@echo "Active Sandboxes:"
	@kubectl get sandbox --no-headers 2>/dev/null | wc -l | xargs -I {} echo "  {}"
	@echo ""
	@echo "Server:"
	@if pgrep -f "python.*server.py" > /dev/null; then \
		echo "  âœ… Running (PID: $$(pgrep -f 'python.*server.py'))"; \
	else \
		echo "  âŒ Not running (run: make dev)"; \
	fi

dev-logs: ## ğŸ“Š View server and router logs
	@echo "ğŸ“‹ Server logs:"
	@if [ -f /tmp/server.log ]; then \
		tail -50 /tmp/server.log; \
	else \
		echo "  No logs (server not running?)"; \
	fi
	@echo ""
	@echo "ğŸ“‹ Router logs:"
	@kubectl logs -l app=sandbox-router --tail=20 --prefix=true 2>/dev/null || echo "  Router not running"

prod-url: ## ğŸ“Š Get production LoadBalancer URL
	@CONTEXT=$$(kubectl config current-context 2>/dev/null); \
	if ! echo "$$CONTEXT" | grep -q "incidentfox-prod"; then \
		echo "âš ï¸  Current context: $$CONTEXT"; \
		echo "ğŸ’¡ Switch to production: kubectl config use-context arn:aws:eks:us-west-2:103002841599:cluster/incidentfox-prod"; \
		echo ""; \
	fi; \
	kubectl get svc incidentfox-server-svc -n incidentfox-prod \
		-o jsonpath='http://{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null && echo "" \
		|| echo "âŒ Not deployed or context not set to production"

test-local-server: ## ğŸ“Š Run quick E2E test against local server
	@echo "ğŸ§ª Testing local server..."
	@curl -s -X POST http://localhost:8000/investigate \
		-H "Content-Type: application/json" \
		-d '{"prompt": "What is 2+2?"}' | head -20
	@echo ""
	@echo "âœ… Test complete"

test-prod: ## ğŸ“Š Run quick E2E test against production
	@echo "ğŸ§ª Testing production..."
	@CONTEXT=$$(kubectl config current-context 2>/dev/null); \
	if ! echo "$$CONTEXT" | grep -q "incidentfox-prod"; then \
		echo "âš ï¸  Current context: $$CONTEXT"; \
		echo "ğŸ’¡ Switch to production: kubectl config use-context arn:aws:eks:us-west-2:103002841599:cluster/incidentfox-prod"; \
		echo ""; \
	fi; \
	PROD_URL=$$(kubectl get svc incidentfox-server-svc -n incidentfox-prod \
		-o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null); \
	if [ -z "$$PROD_URL" ]; then \
		echo "âŒ Production URL not found"; \
		exit 1; \
	fi; \
	curl -s -m 30 -X POST "http://$$PROD_URL/investigate" \
		-H "Content-Type: application/json" \
		-d '{"prompt": "What is 2+2?"}' | head -20
	@echo ""
	@echo "âœ… Test complete"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ› ï¸  INTERNAL (Advanced users only)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

setup: ## Install Python dependencies
	uv venv
	.venv/bin/activate && uv pip install -e .
