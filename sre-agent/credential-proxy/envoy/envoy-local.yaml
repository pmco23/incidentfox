# Envoy proxy configuration for local development (docker-compose)
# Uses Docker network names instead of K8s service names

admin:
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 9901

static_resources:
  listeners:
  - name: http_proxy
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 8001
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: credential_proxy
          codec_type: AUTO

          http_protocol_options:
            allow_absolute_url: true

          # SSE streaming support - disable idle timeout for long-running connections
          stream_idle_timeout: 0s
          request_timeout: 0s

          access_log:
          - name: envoy.access_loggers.stdout
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
              log_format:
                text_format: "[ACCESS] %REQ(:METHOD)% %REQ(:AUTHORITY)% %REQ(:PATH)% -> %UPSTREAM_CLUSTER% %RESPONSE_CODE%\n"

          route_config:
            name: proxy_routes
            virtual_hosts:
            # Anthropic API (with SSE streaming support)
            - name: anthropic
              domains:
              - "api.anthropic.com"
              - "api.anthropic.com:80"
              - "api.anthropic.com:443"
              routes:
              - match:
                  prefix: "/"
                route:
                  cluster: anthropic
                  auto_host_rewrite: true
                  timeout: 0s  # Disable timeout for streaming responses
                  idle_timeout: 0s  # Keep connection alive indefinitely

            # Coralogix API (all regions)
            - name: coralogix_us2
              domains:
              - "api.us2.coralogix.com"
              - "api.us2.coralogix.com:80"
              - "api.us2.coralogix.com:443"
              routes:
              - match:
                  prefix: "/"
                route:
                  cluster: coralogix_us2
                  auto_host_rewrite: true

            - name: coralogix_us1
              domains:
              - "api.us1.coralogix.com"
              - "api.us1.coralogix.com:80"
              - "api.us1.coralogix.com:443"
              routes:
              - match:
                  prefix: "/"
                route:
                  cluster: coralogix_us1
                  auto_host_rewrite: true

            - name: coralogix_eu1
              domains:
              - "api.eu1.coralogix.com"
              - "api.eu1.coralogix.com:443"
              routes:
              - match:
                  prefix: "/"
                route:
                  cluster: coralogix_eu1
                  auto_host_rewrite: true

            - name: coralogix_eu2
              domains:
              - "api.eu2.coralogix.com"
              - "api.eu2.coralogix.com:443"
              routes:
              - match:
                  prefix: "/"
                route:
                  cluster: coralogix_eu2
                  auto_host_rewrite: true

            # Catch-all for ANTHROPIC_BASE_URL usage
            # When SDK uses base URL, it sends requests to the proxy address
            # Route based on path prefix to determine the backend
            - name: base_url_routes
              domains:
              - "*"
              routes:
              # Anthropic API paths (with streaming support)
              - match:
                  prefix: "/v1/"
                route:
                  cluster: anthropic
                  host_rewrite_literal: api.anthropic.com
                  timeout: 0s  # Disable timeout for streaming responses
                  idle_timeout: 0s  # Keep connection alive indefinitely
              - match:
                  prefix: "/api/event_logging/"
                route:
                  cluster: anthropic
                  host_rewrite_literal: api.anthropic.com
                  timeout: 0s
                  idle_timeout: 0s
              # Coralogix paths (via CORALOGIX_BASE_URL)
              - match:
                  prefix: "/api/v1/dataprime/"
                route:
                  cluster: coralogix_us2
                  host_rewrite_literal: api.us2.coralogix.com
              - match:
                  prefix: "/api/v1/query"
                route:
                  cluster: coralogix_us2
                  host_rewrite_literal: api.us2.coralogix.com

          http_filters:
          - name: envoy.filters.http.ext_authz
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
              transport_api_version: V3
              http_service:
                server_uri:
                  # Docker-compose service name
                  uri: http://credential-resolver:8002/check
                  cluster: ext_authz
                  timeout: 2s
                authorization_request:
                  allowed_headers:
                    patterns:
                    - exact: "x-tenant-id"
                    - exact: "x-team-id"
                  headers_to_add:
                  - key: "x-original-host"
                    value: "%REQ(:authority)%"
                authorization_response:
                  allowed_upstream_headers:
                    patterns:
                    - exact: "authorization"
                    - exact: "x-api-key"
              failure_mode_allow: false

          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

  clusters:
  # ext_authz cluster - Docker service name
  - name: ext_authz
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: ext_authz
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                # Docker-compose service name
                address: credential-resolver
                port_value: 8002

  # Anthropic API
  - name: anthropic
    type: LOGICAL_DNS
    dns_lookup_family: V4_ONLY
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: anthropic
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: api.anthropic.com
                port_value: 443
    transport_socket:
      name: envoy.transport_sockets.tls
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
        sni: api.anthropic.com

  # Coralogix clusters (same as production)
  - name: coralogix_us2
    type: LOGICAL_DNS
    dns_lookup_family: V4_ONLY
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: coralogix_us2
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: api.us2.coralogix.com
                port_value: 443
    transport_socket:
      name: envoy.transport_sockets.tls
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
        sni: api.us2.coralogix.com

  - name: coralogix_us1
    type: LOGICAL_DNS
    dns_lookup_family: V4_ONLY
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: coralogix_us1
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: api.us1.coralogix.com
                port_value: 443
    transport_socket:
      name: envoy.transport_sockets.tls
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
        sni: api.us1.coralogix.com

  - name: coralogix_eu1
    type: LOGICAL_DNS
    dns_lookup_family: V4_ONLY
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: coralogix_eu1
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: api.eu1.coralogix.com
                port_value: 443
    transport_socket:
      name: envoy.transport_sockets.tls
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
        sni: api.eu1.coralogix.com

  - name: coralogix_eu2
    type: LOGICAL_DNS
    dns_lookup_family: V4_ONLY
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: coralogix_eu2
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: api.eu2.coralogix.com
                port_value: 443
    transport_socket:
      name: envoy.transport_sockets.tls
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
        sni: api.eu2.coralogix.com
