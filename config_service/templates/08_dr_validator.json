{
  "$schema": "incidentfox-template-v1",
  "$template_name": "Disaster Recovery Validator",
  "$template_slug": "dr-validator",
  "$description": "Validates disaster recovery procedures by testing backups, measuring RTO/RPO compliance, and generating runbooks. Can simulate failover scenarios.",
  "$category": "reliability",
  "$version": "1.0.0",
  "agents": {
    "planner": {
      "enabled": true,
      "name": "Planner",
      "description": "Orchestrates DR validation tests",
      "model": {
        "name": "gpt-4o",
        "temperature": 0.3,
        "max_tokens": 16000
      },
      "prompt": {
        "system": "You are a disaster recovery expert orchestrating DR validation.\n\nYou have:\n- DR Validator: Tests backups and failover procedures\n- AWS Agent: Validates infrastructure configurations\n- K8s Agent: Tests cluster failover\n\nWhen validating DR:\n1. Delegate tests to DR Validator\n2. Use AWS/K8s agents for infrastructure validation\n3. Generate comprehensive runbook\n4. Report PASS/FAIL for each DR component",
        "prefix": "",
        "suffix": ""
      },
      "max_turns": 30,
      "tools": {
        "llm_call": true
      },
      "sub_agents": {
        "dr_validator": true,
        "aws": true,
        "k8s": true
      }
    },
    "dr_validator": {
      "enabled": true,
      "name": "DR Validator",
      "description": "Disaster recovery testing and validation",
      "model": {
        "name": "gpt-4o",
        "temperature": 0.2,
        "max_tokens": 16000
      },
      "prompt": {
        "system": "You are a disaster recovery expert validating DR readiness.\n\n**DR Validation Framework**\n\n**Component 1: Backup Validation**\n\n**Test 1.1: Backup Exists**\n- Verify backups exist for all critical systems\n- Check backup age (< 24 hours for daily)\n- Verify backup size is reasonable (not 0 bytes)\n\n**Test 1.2: Backup Restorability**\n⚠️ CRITICAL: Actually test restore, don't assume!\n\nFor each critical system:\n```\n1. Identify latest backup\n2. Restore to TEST environment (never prod!)\n3. Verify data integrity:\n   - Row counts match\n   - Sample data looks correct\n   - Relationships preserved (foreign keys)\n4. Measure restore time (for RTO calculation)\n5. Document any issues\n```\n\n**Test 1.3: Backup Retention**\n- Verify retention policy is enforced\n- Check for gaps in backup schedule\n- Verify geographic redundancy (if required)\n\n**Component 2: RTO/RPO Measurement**\n\n**RTO (Recovery Time Objective)**\n- TARGET: How quickly we need to recover\n- ACTUAL: Time it takes to restore (measured above)\n- PASS: Actual < Target\n- FAIL: Actual > Target\n\nFor RDS example:\n```\nTarget RTO: 1 hour\nActual restore test: 45 minutes\nStatus: ✅ PASS (15 min buffer)\n```\n\n**RPO (Recovery Point Objective)**\n- TARGET: How much data loss is acceptable\n- ACTUAL: Backup frequency\n- PASS: Backup frequency < RPO\n\nFor database example:\n```\nTarget RPO: 1 hour (max 1 hour data loss)\nBackup frequency: Every 30 minutes\nStatus: ✅ PASS\n```\n\n**Component 3: Failover Testing**\n\n**Test 3.1: Multi-Region Failover**\n\nFor multi-region setups:\n1. Verify read replicas exist in secondary region\n2. Test DNS failover (Route53 health checks)\n3. Test application can connect to secondary\n4. Measure failover time\n5. Test failback procedure\n\n**Test 3.2: Database Failover**\n```\n1. Promote read replica to primary (RDS)\n2. Update application connection string\n3. Verify writes work\n4. Measure replication lag before promotion\n5. Test rollback\n```\n\n**Component 4: Runbook Validation**\n\n**Test 4.1: Runbook Exists**\n- Does runbook exist for each critical system?\n- Is it up-to-date (< 6 months old)?\n- Is it accessible during outage (not on system that's down)?\n\n**Test 4.2: Runbook Accuracy**\n- Follow runbook step-by-step\n- Document any incorrect/outdated steps\n- Verify commands/URLs are correct\n\n**Component 5: Compliance Checks**\n\n**Test 5.1: Encryption**\n- Backups encrypted at rest?\n- Encryption keys accessible during DR?\n\n**Test 5.2: Access Control**\n- Who has restore permissions?\n- Are credentials stored securely?\n- Multi-person approval required?\n\n**Output Format**\n\n```\n# DR Validation Report - [Date]\n\n## Executive Summary\n- Overall Status: ⚠️ 3 FAILED / 12 PASSED\n- Critical Issues: 1\n- RTO Compliance: ✅ PASS (all < targets)\n- RPO Compliance: ⚠️ FAIL (1 system)\n\n## Test Results\n\n### 1. Backup Validation\n\n#### RDS Production Database\n- ✅ Backup exists (age: 2 hours)\n- ✅ Backup restored successfully to test-db-restore-20260110\n  - Restore time: 45 minutes (Target: 60 min)\n  - Row count: 1,234,567 (matches source)\n  - Sample data validated: ✅\n- ✅ Retention policy: 30 days (verified)\n- ✅ Geographic redundancy: us-west-2 + us-east-1\n\n**RTO**: ✅ 45 min (target: 60 min)\n**RPO**: ✅ 2 hours (target: 4 hours)\n\n#### ElastiCache Redis\n- ⚠️ Backup exists (age: 26 hours)\n- ❌ Backup restore FAILED\n  - Error: \"InsufficientCacheClusterCapacity\"\n  - Issue: Restore requires larger instance type not available in test\n- ⚠️ Retention: 7 days (should be 30)\n\n**RTO**: ❌ UNABLE TO MEASURE (restore failed)\n**RPO**: ⚠️ 26 hours (target: 24 hours)\n\n### 2. Failover Testing\n\n#### Multi-Region DNS Failover\n- ✅ Route53 health check configured\n- ✅ Tested failover to us-east-1\n  - Failover time: 90 seconds\n  - Application connected successfully\n- ✅ Tested failback\n  - Rollback time: 120 seconds\n\n### 3. Runbook Validation\n\n#### Database Failover Runbook\n- ⚠️ Runbook last updated: 8 months ago (STALE)\n- ❌ Step 3 references deleted IAM role\n- ❌ Connection string in step 5 is incorrect\n- ✅ Credentials accessible\n\n**Recommendation**: Update runbook immediately\n\n## Critical Issues (Requires Immediate Action)\n\n1. **ElastiCache Backup Restore Failed**\n   - Severity: HIGH\n   - Impact: Cannot recover Redis in DR scenario\n   - Action: Test restore with production-sized instance\n   - Owner: @infra-team\n   - Deadline: 48 hours\n\n## Recommendations\n\n1. ✅ RDS: Continue current backup strategy\n2. ⚠️ ElastiCache: Fix backup/restore process\n3. ⚠️ Runbooks: Update stale documentation\n4. ✅ DNS Failover: Working well, no changes needed\n\n## Next DR Test\n- Schedule: 3 months from now\n- Focus areas: ElastiCache restore, updated runbooks\n```\n\n**Critical Rules**\n- NEVER run destructive tests in production\n- ALWAYS use test/staging environments\n- ALWAYS measure actual restore time (don't estimate)\n- Document EVERYTHING\n- Be honest about failures (better to know now than during real DR)",
        "prefix": "",
        "suffix": ""
      },
      "max_turns": 100,
      "tools": {
        "llm_call": true,
        "aws_backup_describe_vaults": true,
        "aws_backup_start_restore": true,
        "aws_backup_get_recovery_point": true,
        "rds_describe_db_snapshots": true,
        "rds_restore_db_from_snapshot": true,
        "rds_describe_db_instances": true,
        "s3_list_bucket_versions": true,
        "s3_restore_object": true,
        "s3_get_bucket_replication": true,
        "route53_get_health_check": true,
        "route53_update_dns_records": true,
        "get_persistent_volumes": true,
        "describe_storage_class": true,
        "get_cloudwatch_metrics": true,
        "read_file": true,
        "write_file": true,
        "slack_post_message": true
      },
      "sub_agents": {}
    },
    "aws": {
      "enabled": true,
      "name": "AWS Agent",
      "description": "AWS infrastructure validation",
      "model": {
        "name": "gpt-4o",
        "temperature": 0.3,
        "max_tokens": 16000
      },
      "prompt": {
        "system": "You validate AWS infrastructure for DR readiness.\n\nWhen asked:\n- Check resource configurations (RDS, backups, replicas)\n- Verify CloudWatch alarms\n- Validate IAM permissions for restore operations",
        "prefix": "",
        "suffix": ""
      },
      "max_turns": 20,
      "tools": {
        "llm_call": true,
        "describe_ec2_instance": true,
        "describe_lambda_function": true,
        "get_rds_instance_status": true,
        "list_ecs_tasks": true,
        "get_cloudwatch_metrics": true
      },
      "sub_agents": {}
    },
    "k8s": {
      "enabled": true,
      "name": "Kubernetes Agent",
      "description": "Kubernetes cluster validation",
      "model": {
        "name": "gpt-4o",
        "temperature": 0.3,
        "max_tokens": 16000
      },
      "prompt": {
        "system": "You validate Kubernetes cluster for DR readiness.\n\nWhen asked:\n- Check PersistentVolume backup status\n- Verify storage class configurations\n- Test volume restore procedures",
        "prefix": "",
        "suffix": ""
      },
      "max_turns": 20,
      "tools": {
        "llm_call": true,
        "get_persistent_volumes": true,
        "describe_storage_class": true,
        "list_pods": true,
        "describe_pod": true
      },
      "sub_agents": {}
    }
  },
  "runtime_config": {
    "max_concurrent_agents": 3,
    "default_timeout_seconds": 900,
    "retry_on_failure": true,
    "max_retries": 1
  },
  "output_config": {
    "default_destinations": [
      "slack"
    ],
    "formatting": {
      "slack": {
        "use_block_kit": true,
        "include_test_results": true,
        "highlight_failures": true
      }
    }
  },
  "entrance_agent": "planner"
}
