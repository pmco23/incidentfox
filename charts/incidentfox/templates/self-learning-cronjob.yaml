{{- if .Values.services.selfLearning.enabled }}
# =============================================================================
# Self-Learning System CronJobs
#
# Premium feature: Continuous AI improvement through:
# - Knowledge ingestion from external sources
# - Teaching processing (agent-learned knowledge)
# - Knowledge base maintenance
# =============================================================================

---
# Knowledge Ingestion CronJob
# Pulls documentation from Confluence, GitHub, incidents, Grafana
{{- if .Values.services.selfLearning.ingestion.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: incidentfox-kb-ingestion
  namespace: {{ .Values.namespace }}
  labels:
    app: incidentfox-self-learning
    component: ingestion
spec:
  schedule: {{ .Values.services.selfLearning.ingestion.schedule | quote }}
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: {{ .Values.services.selfLearning.ingestion.timeoutSeconds | default 3600 }}
      template:
        metadata:
          labels:
            app: incidentfox-self-learning
            component: ingestion
        spec:
          restartPolicy: OnFailure
          containers:
            - name: ingestion
              image: {{ required "services.selfLearning.image is required" .Values.services.selfLearning.image }}
              imagePullPolicy: {{ .Values.global.imagePullPolicy }}
              command:
                - python
                - -m
                - ai_learning_pipeline
                - run-ingestion
                - --org-id
                - {{ .Values.global.configService.orgId | quote }}
                {{- if .Values.services.selfLearning.teamNodeId }}
                - --team-id
                - {{ .Values.services.selfLearning.teamNodeId | quote }}
                {{- end }}
              env:
                - name: CONFIG_SERVICE_URL
                  value: {{ required "global.configService.url is required" .Values.global.configService.url | quote }}
                - name: CONFIG_SERVICE_ADMIN_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.externalSecrets.contract.configService.secretName | quote }}
                      key: {{ .Values.externalSecrets.contract.configService.adminTokenKey | quote }}
                - name: RAPTOR_URL
                  value: {{ .Values.services.selfLearning.raptorUrl | default "http://incidentfox-knowledge-base:8000" | quote }}
                - name: OPENAI_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.externalSecrets.contract.agentOpenAI.secretName | quote }}
                      key: {{ .Values.externalSecrets.contract.agentOpenAI.apiKeyKey | quote }}
              resources:
{{ toYaml .Values.services.selfLearning.resources | indent 16 }}
{{- end }}

---
# Teaching Processor CronJob
# Processes agent-taught knowledge with approval workflow
{{- if .Values.services.selfLearning.teaching.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: incidentfox-kb-teaching
  namespace: {{ .Values.namespace }}
  labels:
    app: incidentfox-self-learning
    component: teaching
spec:
  schedule: {{ .Values.services.selfLearning.teaching.schedule | quote }}
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: {{ .Values.services.selfLearning.teaching.timeoutSeconds | default 1800 }}
      template:
        metadata:
          labels:
            app: incidentfox-self-learning
            component: teaching
        spec:
          restartPolicy: OnFailure
          containers:
            - name: teaching
              image: {{ required "services.selfLearning.image is required" .Values.services.selfLearning.image }}
              imagePullPolicy: {{ .Values.global.imagePullPolicy }}
              command:
                - python
                - -m
                - ai_learning_pipeline
                - run-teaching
                - --org-id
                - {{ .Values.global.configService.orgId | quote }}
                {{- if .Values.services.selfLearning.teamNodeId }}
                - --team-id
                - {{ .Values.services.selfLearning.teamNodeId | quote }}
                {{- end }}
              env:
                - name: CONFIG_SERVICE_URL
                  value: {{ required "global.configService.url is required" .Values.global.configService.url | quote }}
                - name: CONFIG_SERVICE_ADMIN_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.externalSecrets.contract.configService.secretName | quote }}
                      key: {{ .Values.externalSecrets.contract.configService.adminTokenKey | quote }}
                - name: RAPTOR_URL
                  value: {{ .Values.services.selfLearning.raptorUrl | default "http://incidentfox-knowledge-base:8000" | quote }}
                - name: OPENAI_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.externalSecrets.contract.agentOpenAI.secretName | quote }}
                      key: {{ .Values.externalSecrets.contract.agentOpenAI.apiKeyKey | quote }}
              resources:
{{ toYaml .Values.services.selfLearning.resources | indent 16 }}
{{- end }}

---
# Maintenance CronJob
# Tree health, decay, rebalancing, gap detection
{{- if .Values.services.selfLearning.maintenance.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: incidentfox-kb-maintenance
  namespace: {{ .Values.namespace }}
  labels:
    app: incidentfox-self-learning
    component: maintenance
spec:
  schedule: {{ .Values.services.selfLearning.maintenance.schedule | quote }}
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: {{ .Values.services.selfLearning.maintenance.timeoutSeconds | default 7200 }}
      template:
        metadata:
          labels:
            app: incidentfox-self-learning
            component: maintenance
        spec:
          restartPolicy: OnFailure
          containers:
            - name: maintenance
              image: {{ required "services.selfLearning.image is required" .Values.services.selfLearning.image }}
              imagePullPolicy: {{ .Values.global.imagePullPolicy }}
              command:
                - python
                - -m
                - ai_learning_pipeline
                - run-maintenance
                - --org-id
                - {{ .Values.global.configService.orgId | quote }}
                {{- if .Values.services.selfLearning.teamNodeId }}
                - --team-id
                - {{ .Values.services.selfLearning.teamNodeId | quote }}
                {{- end }}
              env:
                - name: CONFIG_SERVICE_URL
                  value: {{ required "global.configService.url is required" .Values.global.configService.url | quote }}
                - name: CONFIG_SERVICE_ADMIN_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.externalSecrets.contract.configService.secretName | quote }}
                      key: {{ .Values.externalSecrets.contract.configService.adminTokenKey | quote }}
                - name: RAPTOR_URL
                  value: {{ .Values.services.selfLearning.raptorUrl | default "http://incidentfox-knowledge-base:8000" | quote }}
                - name: OPENAI_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.externalSecrets.contract.agentOpenAI.secretName | quote }}
                      key: {{ .Values.externalSecrets.contract.agentOpenAI.apiKeyKey | quote }}
              resources:
{{ toYaml .Values.services.selfLearning.resources | indent 16 }}
{{- end }}
{{- end }}
