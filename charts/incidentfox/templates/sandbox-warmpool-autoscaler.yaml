{{- if and .Values.services.agent.sandbox.enabled .Values.services.agent.warmPool.enabled .Values.services.agent.warmPool.autoscaler.enabled }}
# =============================================================================
# KEDA-Based Warm Pool Autoscaler
# =============================================================================
# Dynamically scales the SandboxWarmPool based on active demand.
# Agent server exposes /metrics/sandbox-demand which returns desired pool size.
# KEDA polls this endpoint and scales the warm pool accordingly.
#
# Prerequisites:
#   - KEDA installed: helm install keda kedacore/keda -n keda --create-namespace
#   - SandboxWarmPool CRD supports /scale subresource
# =============================================================================

---
# ClusterRole - grants KEDA operator access to scale SandboxWarmPool
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ .Release.Name }}-keda-warmpool
  labels:
    app: incidentfox
    component: warmpool-autoscaler
    app.kubernetes.io/name: warmpool-autoscaler
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
rules:
  - apiGroups: ["extensions.agents.x-k8s.io"]
    resources: ["sandboxwarmpools"]
    verbs: ["get", "list", "watch", "patch"]
  - apiGroups: ["extensions.agents.x-k8s.io"]
    resources: ["sandboxwarmpools/scale"]
    verbs: ["get", "update", "patch"]
---
# ClusterRoleBinding - binds to KEDA operator service account
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ .Release.Name }}-keda-warmpool
  labels:
    app: incidentfox
    component: warmpool-autoscaler
    app.kubernetes.io/name: warmpool-autoscaler
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
subjects:
  - kind: ServiceAccount
    name: keda-operator
    namespace: {{ .Values.services.agent.warmPool.autoscaler.kedaNamespace | default "keda" }}
roleRef:
  kind: ClusterRole
  name: {{ .Release.Name }}-keda-warmpool
  apiGroup: rbac.authorization.k8s.io
---
# ScaledObject - KEDA autoscaler targeting SandboxWarmPool
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: {{ .Release.Name }}-warmpool-autoscaler
  namespace: {{ .Values.namespace }}
  labels:
    app: incidentfox
    component: warmpool-autoscaler
    app.kubernetes.io/name: warmpool-autoscaler
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
spec:
  scaleTargetRef:
    apiVersion: extensions.agents.x-k8s.io/v1alpha1
    kind: SandboxWarmPool
    name: {{ .Values.services.agent.warmPool.poolName }}
  minReplicaCount: {{ .Values.services.agent.warmPool.autoscaler.minReplicas }}
  maxReplicaCount: {{ .Values.services.agent.warmPool.autoscaler.maxReplicas }}
  pollingInterval: {{ .Values.services.agent.warmPool.autoscaler.pollingInterval | default 15 }}
  cooldownPeriod: {{ .Values.services.agent.warmPool.autoscaler.cooldownPeriod | default 300 }}
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleUp:
          stabilizationWindowSeconds: 0
          policies:
            - type: Pods
              value: 4
              periodSeconds: 15
        scaleDown:
          stabilizationWindowSeconds: 120
          policies:
            - type: Pods
              value: 1
              periodSeconds: 60
  triggers:
    - type: metrics-api
      metadata:
        url: "http://{{ .Release.Name }}-agent.{{ .Values.namespace }}.svc.cluster.local:{{ .Values.services.agent.servicePort }}/metrics/sandbox-demand"
        valueLocation: "value"
        targetValue: "1"
{{- end }}
