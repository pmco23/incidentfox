{{- if .Values.services.agent.enabled }}
# =============================================================================
# Unified Agent - Investigation agent with sandbox isolation support
# =============================================================================
# Two operation modes:
# 1. Direct mode (sandbox.enabled=false): Agent runs investigations directly
# 2. Sandbox mode (sandbox.enabled=true): Agent creates gVisor sandbox pods
#
# In sandbox mode, this deployment acts as a "sandbox manager" that:
# - Receives investigation requests from orchestrator
# - Creates isolated sandbox pods for each investigation
# - Sandboxes run the same image in server mode (port 8888)
# - Sandboxes connect to credential-resolver for credentials
# =============================================================================
{{- if .Values.services.agent.serviceAccount.create }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Values.services.agent.serviceAccount.name | quote }}
  namespace: {{ .Values.namespace }}
  {{- if .Values.services.agent.serviceAccount.annotations }}
  annotations:
{{ toYaml .Values.services.agent.serviceAccount.annotations | indent 4 }}
  {{- end }}
---
{{- end }}
{{- if .Values.services.agent.sandbox.enabled }}
# RBAC for sandbox management (required when sandbox mode is enabled)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: incidentfox-agent-sandbox-manager
  namespace: {{ .Values.namespace }}
rules:
  # Sandbox CRD management
  - apiGroups: ["agents.x-k8s.io"]
    resources: ["sandboxes"]
    verbs: ["get", "list", "watch", "create", "delete"]
  # Pod observation (for sandbox status)
  - apiGroups: [""]
    resources: ["pods", "services"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["pods/log"]
    verbs: ["get"]
  # ConfigMap for per-sandbox Envoy config
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "create", "update", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: incidentfox-agent-sandbox-manager
  namespace: {{ .Values.namespace }}
subjects:
  - kind: ServiceAccount
    name: {{ .Values.services.agent.serviceAccount.name | quote }}
    namespace: {{ .Values.namespace }}
roleRef:
  kind: Role
  name: incidentfox-agent-sandbox-manager
  apiGroup: rbac.authorization.k8s.io
---
{{- end }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: incidentfox-agent
  namespace: {{ .Values.namespace }}
spec:
  replicas: {{ .Values.services.agent.replicas }}
  selector:
    matchLabels:
      app: incidentfox-agent
  template:
    metadata:
      labels:
        app: incidentfox-agent
    spec:
      {{- if .Values.services.agent.serviceAccount.name }}
      serviceAccountName: {{ .Values.services.agent.serviceAccount.name | quote }}
      {{- end }}
      {{- if .Values.global.imagePullSecrets }}
      imagePullSecrets:
{{ toYaml .Values.global.imagePullSecrets | indent 8 }}
      {{- end }}
      # Allow enough time for graceful shutdown to mark in-flight runs as failed
      terminationGracePeriodSeconds: {{ .Values.services.agent.terminationGracePeriodSeconds | default 60 }}
      containers:
        - name: agent
          image: {{ required "services.agent.image is required" .Values.services.agent.image }}
          imagePullPolicy: {{ .Values.global.imagePullPolicy }}
          # Run unified-agent sandbox server (FastAPI on port 8888 or configured port)
          command: ["python", "-m", "unified_agent.sandbox.server"]
          workingDir: /app
          ports:
            - containerPort: {{ .Values.services.agent.servicePort }}
              name: http
          resources:
{{ toYaml .Values.services.agent.resources | indent 12 }}
          env:
            - name: USE_CONFIG_SERVICE
              value: "true"
            - name: CONFIG_BASE_URL
              value: {{ required "global.configService.url is required" .Values.global.configService.url | quote }}
            - name: CONFIG_SERVICE_URL
              value: {{ required "global.configService.url is required" .Values.global.configService.url | quote }}
            # Dedicated health server port
            - name: HEALTH_SERVER_PORT
              value: {{ .Values.services.agent.healthServer.port | default 8081 | quote }}
            # K8s tools configuration
            {{- if .Values.services.agent.kubernetes.enabled }}
            - name: K8S_ENABLED
              value: "true"
            - name: K8S_NAMESPACE
              value: {{ .Values.services.agent.kubernetes.namespace | default .Values.namespace | quote }}
            {{- else }}
            - name: K8S_ENABLED
              value: "true"
            - name: K8S_NAMESPACE
              value: {{ .Values.namespace | quote }}
            {{- end }}
            # =================================================================
            # Sandbox Mode Configuration (unified-agent sandbox manager)
            # =================================================================
            {{- if .Values.services.agent.sandbox.enabled }}
            # Sandbox image (same image, runs in sandbox server mode)
            - name: SANDBOX_IMAGE
              value: {{ .Values.services.agent.sandbox.image | default .Values.services.agent.image | quote }}
            # Namespace for sandbox pods
            - name: SANDBOX_NAMESPACE
              value: {{ .Values.services.agent.sandbox.namespace | default .Values.namespace | quote }}
            # gVisor runtime for enhanced isolation
            - name: USE_GVISOR
              value: {{ .Values.services.agent.sandbox.useGvisor | default "true" | quote }}
            # Credential resolver namespace (for Envoy ext_authz)
            - name: CREDENTIAL_RESOLVER_NAMESPACE
              value: {{ .Values.namespace | quote }}
            # Router namespace (for sandbox-router service)
            - name: ROUTER_NAMESPACE
              value: {{ .Values.namespace | quote }}
            # JWT secret for signing sandbox tokens
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.externalSecrets.contract.jwtSecret.secretName | default "incidentfox-jwt-secret" }}
                  key: {{ .Values.externalSecrets.contract.jwtSecret.secretKey | default "JWT_SECRET" }}
            {{- end }}
            # =================================================================
            # Tracing configuration (Langfuse / OTEL)
            # =================================================================
            {{- if .Values.services.agent.tracing.enabled }}
            - name: TRACING_ENABLED
              value: "true"
            {{- if .Values.services.agent.tracing.langfuse.enabled }}
            - name: LANGFUSE_HOST
              value: {{ .Values.services.agent.tracing.langfuse.host | quote }}
            - name: LANGFUSE_PUBLIC_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.services.agent.tracing.langfuse.secretName }}
                  key: {{ .Values.services.agent.tracing.langfuse.publicKeyKey }}
            - name: LANGFUSE_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.services.agent.tracing.langfuse.secretName }}
                  key: {{ .Values.services.agent.tracing.langfuse.secretKeyKey }}
            {{- end }}
            {{- if .Values.services.agent.tracing.otlp.enabled }}
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              value: {{ .Values.services.agent.tracing.otlp.endpoint | quote }}
            {{- end }}
            {{- end }}
            # Static team token (dev/single-tenant mode only)
            {{- if .Values.services.agent.staticTeamToken.enabled }}
            - name: INCIDENTFOX_TEAM_TOKEN
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.services.agent.staticTeamToken.secretName }}
                  key: {{ .Values.services.agent.staticTeamToken.secretKey }}
            {{- end }}
            # OpenAI API key (for direct mode, sandbox mode uses credential-resolver)
            {{- if not .Values.services.agent.sandbox.enabled }}
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.externalSecrets.contract.agentOpenAI.secretName }}
                  key: {{ .Values.externalSecrets.contract.agentOpenAI.apiKeyKey }}
            {{- if .Values.externalSecrets.contract.googleChat.enabled }}
            - name: GOOGLE_CHAT_SERVICE_ACCOUNT_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.externalSecrets.contract.googleChat.secretName | quote }}
                  key: {{ .Values.externalSecrets.contract.googleChat.serviceAccountKeyKey | quote }}
            {{- end }}
            {{- if .Values.externalSecrets.contract.teams.enabled }}
            - name: TEAMS_APP_ID
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.externalSecrets.contract.teams.secretName | quote }}
                  key: {{ .Values.externalSecrets.contract.teams.appIdKey | quote }}
            - name: TEAMS_APP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.externalSecrets.contract.teams.secretName | quote }}
                  key: {{ .Values.externalSecrets.contract.teams.appPasswordKey | quote }}
            {{- end }}
            {{- end }}
          # Readiness probe (uses /health on main port since server.py doesn't have separate health server)
          readinessProbe:
            httpGet:
              path: {{ .Values.services.agent.readinessProbe.path | default "/health" }}
              port: {{ .Values.services.agent.servicePort }}
            initialDelaySeconds: {{ .Values.services.agent.readinessProbe.initialDelaySeconds | default 5 }}
            periodSeconds: {{ .Values.services.agent.readinessProbe.periodSeconds | default 10 }}
            timeoutSeconds: {{ .Values.services.agent.readinessProbe.timeoutSeconds | default 5 }}
            failureThreshold: {{ .Values.services.agent.readinessProbe.failureThreshold | default 3 }}
          # Liveness probe
          {{- if .Values.services.agent.livenessProbe.enabled }}
          livenessProbe:
            httpGet:
              path: {{ .Values.services.agent.livenessProbe.path | default "/health" }}
              port: {{ .Values.services.agent.servicePort }}
            initialDelaySeconds: {{ .Values.services.agent.livenessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.services.agent.livenessProbe.periodSeconds }}
            timeoutSeconds: {{ .Values.services.agent.livenessProbe.timeoutSeconds | default 5 }}
            failureThreshold: {{ .Values.services.agent.livenessProbe.failureThreshold | default 3 }}
          {{- end }}
---
apiVersion: v1
kind: Service
metadata:
  name: incidentfox-agent
  namespace: {{ .Values.namespace }}
spec:
  selector:
    app: incidentfox-agent
  ports:
    - port: {{ .Values.services.agent.servicePort }}
      targetPort: {{ .Values.services.agent.servicePort }}
      protocol: TCP
{{- end }}
