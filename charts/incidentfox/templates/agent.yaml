{{- if .Values.services.agent.enabled }}
# =============================================================================
# Agent - SRE investigation agent with sandbox isolation support
# =============================================================================
# In sandbox mode, this deployment acts as a "sandbox manager" that:
# - Receives investigation requests from slack-bot
# - Creates isolated sandbox pods for each investigation
# - Sandboxes run the same image with default CMD (sandbox server)
# - Sandboxes connect to credential-resolver for credentials
# =============================================================================
{{- if .Values.services.agent.serviceAccount.create }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Values.services.agent.serviceAccount.name | quote }}
  namespace: {{ .Values.namespace }}
  {{- if .Values.services.agent.serviceAccount.annotations }}
  annotations:
{{ toYaml .Values.services.agent.serviceAccount.annotations | indent 4 }}
  {{- end }}
---
{{- end }}
{{- if .Values.services.agent.sandbox.enabled }}
# RBAC for sandbox management (required when sandbox mode is enabled)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: incidentfox-agent-sandbox-manager
  namespace: {{ .Values.namespace }}
rules:
  # Sandbox CRD management
  - apiGroups: ["agents.x-k8s.io"]
    resources: ["sandboxes"]
    verbs: ["get", "list", "watch", "create", "delete"]
  # Pod observation (for sandbox status)
  - apiGroups: [""]
    resources: ["pods", "services"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["pods/log"]
    verbs: ["get"]
  # ConfigMap for per-sandbox Envoy config
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "create", "update", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: incidentfox-agent-sandbox-manager
  namespace: {{ .Values.namespace }}
subjects:
  - kind: ServiceAccount
    name: {{ .Values.services.agent.serviceAccount.name | quote }}
    namespace: {{ .Values.namespace }}
roleRef:
  kind: Role
  name: incidentfox-agent-sandbox-manager
  apiGroup: rbac.authorization.k8s.io
---
{{- end }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: incidentfox-agent
  namespace: {{ .Values.namespace }}
spec:
  {{- if not .Values.services.agent.hpa.enabled }}
  replicas: {{ .Values.services.agent.replicas }}
  {{- end }}
  selector:
    matchLabels:
      app: incidentfox-agent
  template:
    metadata:
      labels:
        app: incidentfox-agent
        component: server
    spec:
      {{- if .Values.services.agent.serviceAccount.name }}
      serviceAccountName: {{ .Values.services.agent.serviceAccount.name | quote }}
      {{- end }}
      {{- if .Values.global.imagePullSecrets }}
      imagePullSecrets:
{{ toYaml .Values.global.imagePullSecrets | indent 8 }}
      {{- end }}
      # Allow enough time for graceful shutdown to mark in-flight runs as failed
      terminationGracePeriodSeconds: {{ .Values.services.agent.terminationGracePeriodSeconds | default 60 }}
      {{- with .Values.services.agent.podSecurityContext }}
      securityContext:
{{ toYaml . | indent 8 }}
      {{- end }}
      containers:
        - name: agent
          image: {{ required "services.agent.image is required" .Values.services.agent.image }}
          imagePullPolicy: {{ .Values.global.imagePullPolicy }}
          {{- if .Values.services.agent.command }}
          command:
{{ toYaml .Values.services.agent.command | indent 12 }}
          {{- end }}
          workingDir: /app
          ports:
            - containerPort: {{ .Values.services.agent.servicePort }}
              name: http
            - containerPort: {{ .Values.services.agent.healthServer.port | default 8081 }}
              name: health
          resources:
{{ toYaml .Values.services.agent.resources | indent 12 }}
          env:
            # =================================================================
            # Health server (dedicated liveness endpoint, isolated from event loop)
            # =================================================================
            - name: HEALTH_SERVER_PORT
              value: {{ .Values.services.agent.healthServer.port | default 8081 | quote }}
            # =================================================================
            # Sandbox Mode Configuration
            # =================================================================
            {{- if .Values.services.agent.sandbox.enabled }}
            # Sandbox image (same image, runs in sandbox server mode)
            - name: SANDBOX_IMAGE
              value: {{ .Values.services.agent.sandbox.image | default .Values.services.agent.image | quote }}
            # Namespace for sandbox pods
            - name: SANDBOX_NAMESPACE
              value: {{ .Values.services.agent.sandbox.namespace | default .Values.namespace | quote }}
            # ServiceAccount for sandbox pods (K8s tools read-only access)
            - name: SANDBOX_SERVICE_ACCOUNT
              value: {{ .Release.Name }}-sandbox-pod
            # gVisor runtime for enhanced isolation
            - name: USE_GVISOR
              value: {{ .Values.services.agent.sandbox.useGvisor | default "true" | quote }}
            # Credential resolver namespace (for Envoy ext_authz)
            - name: CREDENTIAL_RESOLVER_NAMESPACE
              value: {{ .Values.namespace | quote }}
            # Router namespace (for sandbox-router service)
            - name: ROUTER_NAMESPACE
              value: {{ .Values.namespace | quote }}
            # JWT secret for signing sandbox tokens
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.externalSecrets.contract.jwtSecret.secretName | default "incidentfox-jwt-secret" }}
                  key: {{ .Values.externalSecrets.contract.jwtSecret.secretKey | default "JWT_SECRET" }}
            {{- end }}
            # =================================================================
            # Warm Pool Configuration
            # =================================================================
            {{- if and .Values.services.agent.sandbox.enabled .Values.services.agent.warmPool.enabled }}
            - name: USE_WARM_POOL
              value: "true"
            - name: WARMPOOL_TEMPLATE_NAME
              value: {{ .Values.services.agent.warmPool.templateName | quote }}
            - name: WARMPOOL_TEMPLATE_NAMESPACE
              value: {{ .Values.services.agent.sandbox.namespace | default .Values.namespace | quote }}
            - name: WARMPOOL_NAME
              value: {{ .Values.services.agent.warmPool.poolName | quote }}
            - name: WARMPOOL_NAMESPACE
              value: {{ .Values.services.agent.sandbox.namespace | default .Values.namespace | quote }}
            {{- if .Values.services.agent.warmPool.autoscaler.enabled }}
            - name: WARMPOOL_BUFFER
              value: {{ .Values.services.agent.warmPool.autoscaler.buffer | default 3 | quote }}
            {{- end }}
            {{- end }}
            # =================================================================
            # Concurrency limit (applies regardless of warm pool)
            # =================================================================
            - name: MAX_CONCURRENT_INVESTIGATIONS
              value: {{ .Values.services.agent.maxConcurrentInvestigations | default 8 | quote }}
            # =================================================================
            # Tracing configuration (Langfuse / OTEL)
            # =================================================================
            {{- if .Values.services.agent.tracing.enabled }}
            - name: TRACING_ENABLED
              value: "true"
            {{- if .Values.services.agent.tracing.langfuse.enabled }}
            - name: LANGFUSE_HOST
              value: {{ .Values.services.agent.tracing.langfuse.host | quote }}
            - name: LANGFUSE_PUBLIC_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.services.agent.tracing.langfuse.secretName }}
                  key: {{ .Values.services.agent.tracing.langfuse.publicKeyKey }}
            - name: LANGFUSE_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.services.agent.tracing.langfuse.secretName }}
                  key: {{ .Values.services.agent.tracing.langfuse.secretKeyKey }}
            {{- end }}
            {{- if .Values.services.agent.tracing.otlp.enabled }}
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              value: {{ .Values.services.agent.tracing.otlp.endpoint | quote }}
            {{- end }}
            {{- end }}
            # Static team token (dev/single-tenant mode only)
            {{- if .Values.services.agent.staticTeamToken.enabled }}
            - name: INCIDENTFOX_TEAM_TOKEN
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.services.agent.staticTeamToken.secretName }}
                  key: {{ .Values.services.agent.staticTeamToken.secretKey }}
            {{- end }}
            # =================================================================
            # Extra env vars (from values)
            # =================================================================
            {{- with .Values.services.agent.extraEnv }}
{{ toYaml . | indent 12 }}
            {{- end }}
          # Startup probe (optional)
          {{- if .Values.services.agent.startupProbe.enabled }}
          startupProbe:
            httpGet:
              path: {{ .Values.services.agent.startupProbe.path | default "/health" }}
              port: {{ .Values.services.agent.servicePort }}
            initialDelaySeconds: {{ .Values.services.agent.startupProbe.initialDelaySeconds | default 5 }}
            periodSeconds: {{ .Values.services.agent.startupProbe.periodSeconds | default 5 }}
            timeoutSeconds: {{ .Values.services.agent.startupProbe.timeoutSeconds | default 5 }}
            failureThreshold: {{ .Values.services.agent.startupProbe.failureThreshold | default 12 }}
          {{- end }}
          # Readiness probe (uses /health on main port since server.py doesn't have separate health server)
          readinessProbe:
            httpGet:
              path: {{ .Values.services.agent.readinessProbe.path | default "/health" }}
              port: {{ .Values.services.agent.servicePort }}
            initialDelaySeconds: {{ .Values.services.agent.readinessProbe.initialDelaySeconds | default 5 }}
            periodSeconds: {{ .Values.services.agent.readinessProbe.periodSeconds | default 10 }}
            timeoutSeconds: {{ .Values.services.agent.readinessProbe.timeoutSeconds | default 5 }}
            failureThreshold: {{ .Values.services.agent.readinessProbe.failureThreshold | default 3 }}
          # Liveness probe â€” targets dedicated health server (separate thread, always responsive)
          {{- if .Values.services.agent.livenessProbe.enabled }}
          livenessProbe:
            httpGet:
              path: {{ .Values.services.agent.livenessProbe.path | default "/health" }}
              port: {{ .Values.services.agent.healthServer.port | default 8081 }}
            initialDelaySeconds: {{ .Values.services.agent.livenessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.services.agent.livenessProbe.periodSeconds }}
            timeoutSeconds: {{ .Values.services.agent.livenessProbe.timeoutSeconds | default 5 }}
            failureThreshold: {{ .Values.services.agent.livenessProbe.failureThreshold | default 3 }}
          {{- end }}
---
apiVersion: v1
kind: Service
metadata:
  name: incidentfox-agent
  namespace: {{ .Values.namespace }}
spec:
  selector:
    app: incidentfox-agent
    component: server
  ports:
    - port: {{ .Values.services.agent.servicePort }}
      targetPort: {{ .Values.services.agent.servicePort }}
      protocol: TCP
      name: http
{{- end }}
