{{- if .Values.services.agent.enabled }}
{{- if .Values.services.agent.serviceAccount.create }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Values.services.agent.serviceAccount.name | quote }}
  namespace: {{ .Values.namespace }}
  {{- if .Values.services.agent.serviceAccount.annotations }}
  annotations:
{{ toYaml .Values.services.agent.serviceAccount.annotations | indent 4 }}
  {{- end }}
---
{{- end }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: incidentfox-agent
  namespace: {{ .Values.namespace }}
spec:
  replicas: {{ .Values.services.agent.replicas }}
  selector:
    matchLabels:
      app: incidentfox-agent
  template:
    metadata:
      labels:
        app: incidentfox-agent
    spec:
      {{- if .Values.services.agent.serviceAccount.name }}
      serviceAccountName: {{ .Values.services.agent.serviceAccount.name | quote }}
      {{- end }}
      {{- if .Values.global.imagePullSecrets }}
      imagePullSecrets:
{{ toYaml .Values.global.imagePullSecrets | indent 8 }}
      {{- end }}
      # Allow enough time for graceful shutdown to mark in-flight runs as failed
      # Default K8s is 30s, but agent runs can take 5+ minutes. We need time to:
      # 1. Stop accepting new requests
      # 2. Mark all in-flight runs as failed (HTTP calls to config service)
      terminationGracePeriodSeconds: {{ .Values.services.agent.terminationGracePeriodSeconds | default 60 }}
      containers:
        - name: agent
          image: {{ required "services.agent.image is required" .Values.services.agent.image }}
          imagePullPolicy: {{ .Values.global.imagePullPolicy }}
          ports:
            - containerPort: {{ .Values.services.agent.servicePort }}
              name: http
            - containerPort: {{ .Values.services.agent.healthServer.port | default 8081 }}
              name: health
          resources:
{{ toYaml .Values.services.agent.resources | indent 12 }}
          env:
            - name: USE_CONFIG_SERVICE
              value: "true"
            - name: CONFIG_BASE_URL
              value: {{ required "global.configService.url is required" .Values.global.configService.url | quote }}
            # Dedicated health server port (separate from main Sanic server)
            - name: HEALTH_SERVER_PORT
              value: {{ .Values.services.agent.healthServer.port | default 8081 | quote }}
            # Enable K8s tools (agent has in-cluster access via service account)
            - name: K8S_ENABLED
              value: "true"
            - name: K8S_NAMESPACE
              value: {{ .Values.namespace | quote }}
            # Tracing configuration (Langfuse / OTEL)
            {{- if .Values.services.agent.tracing.enabled }}
            - name: TRACING_ENABLED
              value: "true"
            {{- if .Values.services.agent.tracing.langfuse.enabled }}
            - name: LANGFUSE_HOST
              value: {{ .Values.services.agent.tracing.langfuse.host | quote }}
            - name: LANGFUSE_PUBLIC_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.services.agent.tracing.langfuse.secretName }}
                  key: {{ .Values.services.agent.tracing.langfuse.publicKeyKey }}
            - name: LANGFUSE_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.services.agent.tracing.langfuse.secretName }}
                  key: {{ .Values.services.agent.tracing.langfuse.secretKeyKey }}
            {{- end }}
            {{- if .Values.services.agent.tracing.otlp.enabled }}
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              value: {{ .Values.services.agent.tracing.otlp.endpoint | quote }}
            {{- end }}
            {{- end }}
            {{- if .Values.services.agent.staticTeamToken.enabled }}
            - name: INCIDENTFOX_TEAM_TOKEN
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.services.agent.staticTeamToken.secretName }}
                  key: {{ .Values.services.agent.staticTeamToken.secretKey }}
            {{- end }}
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.externalSecrets.contract.agentOpenAI.secretName }}
                  key: {{ .Values.externalSecrets.contract.agentOpenAI.apiKeyKey }}
          # Readiness probe: Uses dedicated health server on separate thread
          # Returns 503 if heartbeat is stale (agent not making progress)
          readinessProbe:
            httpGet:
              path: /readyz
              port: {{ .Values.services.agent.healthServer.port | default 8081 }}
            initialDelaySeconds: {{ .Values.services.agent.readinessProbe.initialDelaySeconds | default 5 }}
            periodSeconds: {{ .Values.services.agent.readinessProbe.periodSeconds | default 10 }}
            timeoutSeconds: {{ .Values.services.agent.readinessProbe.timeoutSeconds | default 5 }}
            failureThreshold: {{ .Values.services.agent.readinessProbe.failureThreshold | default 3 }}
          # Liveness probe: Uses dedicated health server on separate thread
          # Always returns 200 if process is alive (won't be blocked by long operations)
          {{- if .Values.services.agent.livenessProbe.enabled }}
          livenessProbe:
            httpGet:
              path: /livez
              port: {{ .Values.services.agent.healthServer.port | default 8081 }}
            initialDelaySeconds: {{ .Values.services.agent.livenessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.services.agent.livenessProbe.periodSeconds }}
            timeoutSeconds: {{ .Values.services.agent.livenessProbe.timeoutSeconds | default 5 }}
            failureThreshold: {{ .Values.services.agent.livenessProbe.failureThreshold | default 3 }}
          {{- end }}
---
apiVersion: v1
kind: Service
metadata:
  name: incidentfox-agent
  namespace: {{ .Values.namespace }}
spec:
  selector:
    app: incidentfox-agent
  ports:
    - port: {{ .Values.services.agent.servicePort }}
      targetPort: {{ .Values.services.agent.servicePort }}
      protocol: TCP
{{- end }}


