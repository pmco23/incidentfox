{{- if and .Values.gvisor .Values.gvisor.enabled }}
---
# RuntimeClass for gVisor sandboxed workloads
apiVersion: node.k8s.io/v1
kind: RuntimeClass
metadata:
  name: gvisor
  labels:
    app.kubernetes.io/name: gvisor
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version }}
handler: runsc
---
# DaemonSet to install gVisor on all EKS nodes
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: gvisor-installer
  namespace: kube-system
  labels:
    app: gvisor-installer
    app.kubernetes.io/name: gvisor-installer
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version }}
  annotations:
    meta.helm.sh/release-name: {{ .Release.Name }}
    meta.helm.sh/release-namespace: {{ .Release.Namespace }}
spec:
  selector:
    matchLabels:
      app: gvisor-installer
  template:
    metadata:
      labels:
        app: gvisor-installer
    spec:
      hostPID: true
      hostNetwork: true
      initContainers:
      - name: installer
        image: {{ .Values.gvisor.installerImage | default "alpine:latest" }}
        securityContext:
          privileged: true
        volumeMounts:
        - name: host-root
          mountPath: /host
        command: ["/bin/sh", "-c"]
        args:
        - |
          set -ex
          echo "Installing gVisor..."

          # Install dependencies
          apk add --no-cache wget

          # Detect architecture
          ARCH=$(uname -m)
          echo "Architecture: $ARCH"

          # Download runsc and containerd-shim
          cd /tmp
          URL="https://storage.googleapis.com/gvisor/releases/release/latest/${ARCH}"
          echo "Downloading from: $URL"
          wget "${URL}/runsc" "${URL}/runsc.sha512"
          wget "${URL}/containerd-shim-runsc-v1" "${URL}/containerd-shim-runsc-v1.sha512"

          # Verify checksums
          sha512sum -c runsc.sha512
          sha512sum -c containerd-shim-runsc-v1.sha512
          rm *.sha512

          # Install runsc and shim
          chmod a+rx runsc containerd-shim-runsc-v1
          cp runsc /host/usr/local/bin/runsc
          cp containerd-shim-runsc-v1 /host/usr/local/bin/containerd-shim-runsc-v1
          echo "runsc and shim installed"

          # Configure containerd for gVisor runtime
          # containerd uses /etc/containerd/config.toml (default path, no --config flag)
          echo "Configuring containerd..."
          CONFIG=/host/etc/containerd/config.toml

          # Clean up any bad drop-in configs from previous installer versions
          rm -f /host/etc/containerd/config.d/gvisor.toml 2>/dev/null || true

          # Detect containerd CRI plugin path (v2 uses cri.v1.runtime, v1 uses grpc.v1.cri)
          if grep -q 'io.containerd.cri.v1.runtime' "$CONFIG" 2>/dev/null; then
            CRI_PLUGIN='io.containerd.cri.v1.runtime'
          else
            CRI_PLUGIN='io.containerd.grpc.v1.cri'
          fi
          echo "Detected CRI plugin: $CRI_PLUGIN"

          # Add runsc runtime to containerd config (idempotent)
          if ! grep -q 'runtimes.runsc' "$CONFIG" 2>/dev/null; then
            echo "Adding runsc runtime to containerd config..."
            printf '\n[plugins."%s".containerd.runtimes.runsc]\nruntime_type = "io.containerd.runsc.v1"\n' "$CRI_PLUGIN" >> "$CONFIG"
          else
            echo "runsc runtime already configured"
          fi

          # Restart containerd to pick up new runtime config
          echo "Restarting containerd..."
          nsenter --target 1 --mount --uts --ipc --net --pid -- systemctl restart containerd
          sleep 5

          echo "gVisor installation complete!"

          # Verify installation
          if /host/usr/local/bin/runsc --version; then
            echo "runsc is working!"
          else
            echo "runsc verification failed"
            exit 1
          fi
      containers:
      - name: pause
        image: {{ .Values.gvisor.pauseImage | default "gcr.io/google-containers/pause:3.2" }}
        resources:
          requests:
            cpu: 10m
            memory: 10Mi
      volumes:
      - name: host-root
        hostPath:
          path: /
          type: Directory
      tolerations:
      - operator: Exists
{{- end }}
