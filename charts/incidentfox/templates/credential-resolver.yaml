{{- if .Values.services.credentialResolver.enabled }}
# =============================================================================
# Credential Resolver - JWT-secured credential injection for sandbox pods
# =============================================================================
# This service validates sandbox JWTs and injects credentials into outbound
# requests via Envoy ext_authz. Sandboxes cannot access credentials directly.
#
# Security model:
# 1. Server generates JWT when creating sandbox (contains tenant/team identity)
# 2. JWT embedded in per-sandbox Envoy ConfigMap
# 3. Envoy adds x-sandbox-jwt header to ext_authz requests
# 4. This service validates JWT and injects credentials from Config Service
# =============================================================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Values.services.credentialResolver.serviceAccount.name | default "credential-resolver" }}
  namespace: {{ .Values.namespace }}
  labels:
    app: incidentfox-credential-resolver
    component: security
  {{- if .Values.services.credentialResolver.serviceAccount.annotations }}
  annotations:
{{ toYaml .Values.services.credentialResolver.serviceAccount.annotations | indent 4 }}
  {{- end }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: incidentfox-credential-resolver
  namespace: {{ .Values.namespace }}
  labels:
    app: incidentfox-credential-resolver
    component: security
spec:
  replicas: {{ .Values.services.credentialResolver.replicas | default 2 }}
  selector:
    matchLabels:
      app: incidentfox-credential-resolver
  template:
    metadata:
      labels:
        app: incidentfox-credential-resolver
        component: security
    spec:
      serviceAccountName: {{ .Values.services.credentialResolver.serviceAccount.name | default "credential-resolver" }}
      {{- if .Values.global.imagePullSecrets }}
      imagePullSecrets:
{{ toYaml .Values.global.imagePullSecrets | indent 8 }}
      {{- end }}
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      containers:
        - name: credential-resolver
          image: {{ required "services.credentialResolver.image is required" .Values.services.credentialResolver.image }}
          imagePullPolicy: {{ .Values.global.imagePullPolicy }}
          ports:
            - containerPort: {{ .Values.services.credentialResolver.servicePort | default 8002 }}
              name: http
              protocol: TCP
          resources:
{{ toYaml .Values.services.credentialResolver.resources | indent 12 }}
          env:
            # Credential source: config_service (multi-tenant) or environment (dev)
            - name: CREDENTIAL_SOURCE
              value: {{ .Values.services.credentialResolver.credentialSource | default "config_service" | quote }}
            # Config Service URL for fetching team credentials
            - name: CONFIG_SERVICE_URL
              value: {{ required "global.configService.url is required" .Values.global.configService.url | quote }}
            # JWT validation mode: strict (require valid JWT) or permissive (dev)
            - name: JWT_MODE
              value: {{ .Values.services.credentialResolver.jwtMode | default "strict" | quote }}
            # JWT secret for validating sandbox tokens (must match unified-agent server)
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.externalSecrets.contract.jwtSecret.secretName | default "incidentfox-jwt-secret" }}
                  key: {{ .Values.externalSecrets.contract.jwtSecret.secretKey | default "JWT_SECRET" }}
            # Shared Anthropic API key for free trials (optional fallback)
            {{- if .Values.services.credentialResolver.sharedAnthropicKey.enabled }}
            - name: SHARED_ANTHROPIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.services.credentialResolver.sharedAnthropicKey.secretName }}
                  key: {{ .Values.services.credentialResolver.sharedAnthropicKey.secretKey }}
                  optional: true
            {{- end }}
            # AWS region for Secrets Manager fallback
            - name: AWS_REGION
              value: {{ .Values.externalSecrets.awsRegion | default "us-west-2" | quote }}
          # Health probes
          livenessProbe:
            httpGet:
              path: /health
              port: {{ .Values.services.credentialResolver.servicePort | default 8002 }}
            initialDelaySeconds: {{ .Values.services.credentialResolver.livenessProbe.initialDelaySeconds | default 5 }}
            periodSeconds: {{ .Values.services.credentialResolver.livenessProbe.periodSeconds | default 10 }}
            timeoutSeconds: {{ .Values.services.credentialResolver.livenessProbe.timeoutSeconds | default 5 }}
            failureThreshold: {{ .Values.services.credentialResolver.livenessProbe.failureThreshold | default 3 }}
          readinessProbe:
            httpGet:
              path: /health
              port: {{ .Values.services.credentialResolver.servicePort | default 8002 }}
            initialDelaySeconds: {{ .Values.services.credentialResolver.readinessProbe.initialDelaySeconds | default 5 }}
            periodSeconds: {{ .Values.services.credentialResolver.readinessProbe.periodSeconds | default 5 }}
            timeoutSeconds: {{ .Values.services.credentialResolver.readinessProbe.timeoutSeconds | default 5 }}
            failureThreshold: {{ .Values.services.credentialResolver.readinessProbe.failureThreshold | default 3 }}
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
      # Anti-affinity to spread pods across nodes
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app: incidentfox-credential-resolver
                topologyKey: kubernetes.io/hostname
---
apiVersion: v1
kind: Service
metadata:
  name: incidentfox-credential-resolver
  namespace: {{ .Values.namespace }}
  labels:
    app: incidentfox-credential-resolver
    component: security
spec:
  type: ClusterIP
  selector:
    app: incidentfox-credential-resolver
  ports:
    - name: http
      port: {{ .Values.services.credentialResolver.servicePort | default 8002 }}
      targetPort: {{ .Values.services.credentialResolver.servicePort | default 8002 }}
      protocol: TCP
{{- end }}
