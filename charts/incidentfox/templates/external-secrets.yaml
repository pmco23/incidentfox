{{- if .Values.externalSecrets.enabled }}
# External Secrets Operator (ESO) integration.
# This chart assumes ESO is installed in the cluster.

{{- $apiVersion := (.Values.externalSecrets.apiVersion | default "external-secrets.io/v1") }}

{{- if .Values.externalSecrets.installClusterSecretStore }}
---
apiVersion: {{ $apiVersion }}
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager
spec:
  provider:
    aws:
      service: SecretsManager
      region: {{ .Values.externalSecrets.awsRegion | quote }}
{{- end }}

{{- $c := .Values.externalSecrets.contract }}

{{- if $c.databaseUrl.enabled }}
---
apiVersion: {{ $apiVersion }}
kind: ExternalSecret
metadata:
  name: {{ $c.databaseUrl.secretName | quote }}
  namespace: {{ $.Values.namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: {{ $c.databaseUrl.secretName | quote }}
    creationPolicy: Owner
  data:
    - secretKey: {{ $c.databaseUrl.secretKey | quote }}
      remoteRef:
        key: {{ $c.databaseUrl.remoteRefKey | quote }}
{{- end }}

{{- if $c.configService.enabled }}
---
apiVersion: {{ $apiVersion }}
kind: ExternalSecret
metadata:
  name: {{ $c.configService.secretName | quote }}
  namespace: {{ $.Values.namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: {{ $c.configService.secretName | quote }}
    creationPolicy: Owner
  data:
    - secretKey: {{ $c.configService.adminTokenKey | quote }}
      remoteRef:
        key: {{ $c.configService.adminTokenRemoteRefKey | quote }}
    - secretKey: {{ $c.configService.tokenPepperKey | quote }}
      remoteRef:
        key: {{ $c.configService.tokenPepperRemoteRefKey | quote }}
    - secretKey: {{ $c.configService.impersonationJwtSecretKey | quote }}
      remoteRef:
        key: {{ $c.configService.impersonationJwtSecretRemoteRefKey | quote }}
{{- end }}

{{- if $c.agentOpenAI.enabled }}
---
apiVersion: {{ $apiVersion }}
kind: ExternalSecret
metadata:
  name: {{ $c.agentOpenAI.secretName | quote }}
  namespace: {{ $.Values.namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: {{ $c.agentOpenAI.secretName | quote }}
    creationPolicy: Owner
  data:
    - secretKey: {{ $c.agentOpenAI.apiKeyKey | quote }}
      remoteRef:
        key: {{ $c.agentOpenAI.apiKeyRemoteRefKey | quote }}
{{- end }}

{{- if $c.webUiOidc.enabled }}
---
apiVersion: {{ $apiVersion }}
kind: ExternalSecret
metadata:
  name: {{ $c.webUiOidc.secretName | quote }}
  namespace: {{ $.Values.namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: {{ $c.webUiOidc.secretName | quote }}
    creationPolicy: Owner
  data:
    - secretKey: {{ $c.webUiOidc.clientSecretKey | quote }}
      remoteRef:
        key: {{ $c.webUiOidc.clientSecretRemoteRefKey | quote }}
{{- end }}

{{- if $c.slack.enabled }}
---
apiVersion: {{ $apiVersion }}
kind: ExternalSecret
metadata:
  name: {{ $c.slack.secretName | quote }}
  namespace: {{ $.Values.namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: {{ $c.slack.secretName | quote }}
    creationPolicy: Owner
  data:
    - secretKey: {{ $c.slack.signingSecretKey | quote }}
      remoteRef:
        key: {{ $c.slack.signingSecretRemoteRefKey | quote }}
    - secretKey: {{ $c.slack.botTokenKey | quote }}
      remoteRef:
        key: {{ $c.slack.botTokenRemoteRefKey | quote }}
{{- end }}

{{- if $c.github.enabled }}
---
apiVersion: {{ $apiVersion }}
kind: ExternalSecret
metadata:
  name: {{ $c.github.secretName | quote }}
  namespace: {{ $.Values.namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: {{ $c.github.secretName | quote }}
    creationPolicy: Owner
  data:
    - secretKey: {{ $c.github.webhookSecretKey | quote }}
      remoteRef:
        key: {{ $c.github.remoteRefKey | quote }}
        {{- if $c.github.remoteRefProperty }}
        property: {{ $c.github.remoteRefProperty | quote }}
        {{- end }}
{{- end }}

{{- if $c.pagerduty.enabled }}
---
apiVersion: {{ $apiVersion }}
kind: ExternalSecret
metadata:
  name: {{ $c.pagerduty.secretName | quote }}
  namespace: {{ $.Values.namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: {{ $c.pagerduty.secretName | quote }}
    creationPolicy: Owner
  data:
    - secretKey: {{ $c.pagerduty.webhookSecretKey | quote }}
      remoteRef:
        key: {{ $c.pagerduty.remoteRefKey | quote }}
{{- end }}

{{- if $c.incidentio.enabled }}
---
apiVersion: {{ $apiVersion }}
kind: ExternalSecret
metadata:
  name: {{ $c.incidentio.secretName | quote }}
  namespace: {{ $.Values.namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: {{ $c.incidentio.secretName | quote }}
    creationPolicy: Owner
  data:
    - secretKey: {{ $c.incidentio.webhookSecretKey | quote }}
      remoteRef:
        key: {{ $c.incidentio.remoteRefKey | quote }}
{{- end }}

{{- if $c.orchestratorInternal.enabled }}
---
apiVersion: {{ $apiVersion }}
kind: ExternalSecret
metadata:
  name: {{ $c.orchestratorInternal.secretName | quote }}
  namespace: {{ $.Values.namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: {{ $c.orchestratorInternal.secretName | quote }}
    creationPolicy: Owner
  data:
    - secretKey: {{ $c.orchestratorInternal.internalTokenKey | quote }}
      remoteRef:
        key: {{ $c.orchestratorInternal.internalTokenRemoteRefKey | quote }}
{{- end }}

{{- if $c.langfuse.enabled }}
---
apiVersion: {{ $apiVersion }}
kind: ExternalSecret
metadata:
  name: {{ $c.langfuse.secretName | quote }}
  namespace: {{ $.Values.namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: {{ $c.langfuse.secretName | quote }}
    creationPolicy: Owner
  data:
    - secretKey: {{ $c.langfuse.publicKeyKey | quote }}
      remoteRef:
        key: {{ $c.langfuse.publicKeyRemoteRefKey | quote }}
    - secretKey: {{ $c.langfuse.secretKeyKey | quote }}
      remoteRef:
        key: {{ $c.langfuse.secretKeyRemoteRefKey | quote }}
{{- end }}

{{- if $c.newRelic.enabled }}
---
apiVersion: {{ $apiVersion }}
kind: ExternalSecret
metadata:
  name: {{ $c.newRelic.secretName | quote }}
  namespace: {{ $.Values.namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: {{ $c.newRelic.secretName | quote }}
    creationPolicy: Owner
  data:
    - secretKey: {{ $c.newRelic.apiKeyKey | quote }}
      remoteRef:
        key: {{ $c.newRelic.apiKeyRemoteRefKey | quote }}
{{- end }}

{{- if $c.recall.enabled }}
---
apiVersion: {{ $apiVersion }}
kind: ExternalSecret
metadata:
  name: {{ $c.recall.secretName | quote }}
  namespace: {{ $.Values.namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: {{ $c.recall.secretName | quote }}
    creationPolicy: Owner
  data:
    - secretKey: {{ $c.recall.apiKeyKey | quote }}
      remoteRef:
        key: {{ $c.recall.apiKeyRemoteRefKey | quote }}
    - secretKey: {{ $c.recall.webhookSecretKey | quote }}
      remoteRef:
        key: {{ $c.recall.webhookSecretRemoteRefKey | quote }}
{{- end }}

{{- if $c.googleChat.enabled }}
---
apiVersion: {{ $apiVersion }}
kind: ExternalSecret
metadata:
  name: {{ $c.googleChat.secretName | quote }}
  namespace: {{ $.Values.namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: {{ $c.googleChat.secretName | quote }}
    creationPolicy: Owner
  data:
    - secretKey: {{ $c.googleChat.projectIdKey | quote }}
      remoteRef:
        key: {{ $c.googleChat.projectIdRemoteRefKey | quote }}
    - secretKey: {{ $c.googleChat.serviceAccountKeyKey | quote }}
      remoteRef:
        key: {{ $c.googleChat.serviceAccountKeyRemoteRefKey | quote }}
{{- end }}

{{- if $c.teams.enabled }}
---
apiVersion: {{ $apiVersion }}
kind: ExternalSecret
metadata:
  name: {{ $c.teams.secretName | quote }}
  namespace: {{ $.Values.namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: {{ $c.teams.secretName | quote }}
    creationPolicy: Owner
  data:
    - secretKey: {{ $c.teams.appIdKey | quote }}
      remoteRef:
        key: {{ $c.teams.appIdRemoteRefKey | quote }}
    - secretKey: {{ $c.teams.appPasswordKey | quote }}
      remoteRef:
        key: {{ $c.teams.appPasswordRemoteRefKey | quote }}
    - secretKey: {{ $c.teams.tenantIdKey | quote }}
      remoteRef:
        key: {{ $c.teams.tenantIdRemoteRefKey | quote }}
{{- end }}

{{- if $c.jwtSecret.enabled }}
---
# JWT secret for sandbox credential injection (shared between agent and credential-resolver)
apiVersion: {{ $apiVersion }}
kind: ExternalSecret
metadata:
  name: {{ $c.jwtSecret.secretName | quote }}
  namespace: {{ $.Values.namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: {{ $c.jwtSecret.secretName | quote }}
    creationPolicy: Owner
  data:
    - secretKey: {{ $c.jwtSecret.secretKey | quote }}
      remoteRef:
        key: {{ $c.jwtSecret.remoteRefKey | quote }}
{{- end }}

{{- if $c.sharedAnthropicKey.enabled }}
---
# Shared Anthropic API key for free trials
apiVersion: {{ $apiVersion }}
kind: ExternalSecret
metadata:
  name: {{ $c.sharedAnthropicKey.secretName | quote }}
  namespace: {{ $.Values.namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: {{ $c.sharedAnthropicKey.secretName | quote }}
    creationPolicy: Owner
  data:
    - secretKey: {{ $c.sharedAnthropicKey.secretKey | quote }}
      remoteRef:
        key: {{ $c.sharedAnthropicKey.remoteRefKey | quote }}
        property: api_key
{{- end }}

{{- if $c.slackBot.enabled }}
---
# Slack Bot OAuth credentials (for multi-workspace distribution)
apiVersion: {{ $apiVersion }}
kind: ExternalSecret
metadata:
  name: {{ $c.slackBot.secretName | quote }}
  namespace: {{ $.Values.namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: {{ $c.slackBot.secretName | quote }}
    creationPolicy: Owner
  data:
    - secretKey: {{ $c.slackBot.clientIdKey | quote }}
      remoteRef:
        key: {{ $c.slackBot.clientIdRemoteRefKey | quote }}
    - secretKey: {{ $c.slackBot.clientSecretKey | quote }}
      remoteRef:
        key: {{ $c.slackBot.clientSecretRemoteRefKey | quote }}
    - secretKey: {{ $c.slackBot.signingSecretKey | quote }}
      remoteRef:
        key: {{ $c.slackBot.signingSecretRemoteRefKey | quote }}
{{- end }}

{{- if .Values.externalSecrets.vercel.enabled }}
---
apiVersion: {{ $apiVersion }}
kind: ExternalSecret
metadata:
  name: incidentfox-vercel
  namespace: {{ $.Values.namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: incidentfox-vercel
    creationPolicy: Owner
  data:
    - secretKey: token
      remoteRef:
        key: {{ .Values.externalSecrets.vercel.secretPath | quote }}
        property: token
    - secretKey: team_id
      remoteRef:
        key: {{ .Values.externalSecrets.vercel.secretPath | quote }}
        property: team_id
    - secretKey: webhook_secret
      remoteRef:
        key: {{ .Values.externalSecrets.vercel.secretPath | quote }}
        property: webhook_secret
{{- end }}

{{- if and $c.encryptionKey $c.encryptionKey.enabled }}
---
# Encryption key for config-service column encryption
apiVersion: {{ $apiVersion }}
kind: ExternalSecret
metadata:
  name: {{ $c.encryptionKey.secretName | quote }}
  namespace: {{ $.Values.namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: {{ $c.encryptionKey.secretName | quote }}
    creationPolicy: Owner
  data:
    - secretKey: {{ $c.encryptionKey.secretKey | quote }}
      remoteRef:
        key: {{ $c.encryptionKey.remoteRefKey | quote }}
{{- end }}

{{- end }}


