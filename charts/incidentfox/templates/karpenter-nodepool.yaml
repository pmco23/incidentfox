{{- if and .Values.karpenter .Values.karpenter.enabled }}
# =============================================================================
# Karpenter NodePool + EC2NodeClass â€” burst node provisioning
# =============================================================================
# Auto-provisions AMD64 (x86) nodes when sandbox pods are Pending.
# Consolidates and removes nodes when idle. gVisor installs automatically
# via the gvisor-installer DaemonSet (tolerates all taints).
# =============================================================================

---
apiVersion: karpenter.sh/v1
kind: NodePool
metadata:
  name: sandbox-burst
spec:
  template:
    spec:
      nodeClassRef:
        group: karpenter.k8s.aws
        kind: EC2NodeClass
        name: sandbox-burst
      requirements:
        - key: kubernetes.io/arch
          operator: In
          values: ["amd64"]
        - key: karpenter.sh/capacity-type
          operator: In
          values:
{{ toYaml .Values.karpenter.capacityTypes | indent 12 }}
        - key: karpenter.k8s.aws/instance-category
          operator: In
          values: ["c", "m"]
        - key: karpenter.k8s.aws/instance-generation
          operator: Gt
          values: ["6"]
        - key: karpenter.k8s.aws/instance-size
          operator: In
          values: ["medium", "large", "xlarge", "2xlarge"]
  limits:
    cpu: {{ .Values.karpenter.limits.cpu | quote }}
    memory: {{ .Values.karpenter.limits.memory | quote }}
  disruption:
    consolidationPolicy: WhenEmptyOrUnderutilized
    consolidateAfter: {{ .Values.karpenter.consolidateAfter | quote }}
    budgets:
      - nodes: "10%"

---
apiVersion: karpenter.k8s.aws/v1
kind: EC2NodeClass
metadata:
  name: sandbox-burst
spec:
  amiSelectorTerms:
    - alias: al2023@latest
  subnetSelectorTerms:
    - tags:
        karpenter.sh/discovery: {{ .Values.karpenter.clusterName }}
  securityGroupSelectorTerms:
    - tags:
        karpenter.sh/discovery: {{ .Values.karpenter.clusterName }}
  role: {{ .Values.karpenter.nodeRoleName }}
  blockDeviceMappings:
    - deviceName: /dev/xvda
      ebs:
        volumeSize: {{ .Values.karpenter.rootVolumeSize | quote }}
        volumeType: gp3
        encrypted: true
        deleteOnTermination: true
  metadataOptions:
    httpEndpoint: enabled
    httpPutResponseHopLimit: 2
    httpTokens: required
  tags:
    Name: {{ .Values.karpenter.clusterName }}-karpenter-sandbox
    ManagedBy: karpenter
{{- end }}
